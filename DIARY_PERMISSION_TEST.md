# 日记权限功能测试指南

## 🎯 功能概述
日记权限为博客提供额外的密码保护层，即使用户已登录，也需要输入系统配置的日记密码才能访问标记为"日记"的博客。

## 🔧 测试准备

### 1. 配置日记密码（可选）
在系统配置文件中添加：
```
diary_password=your_secure_password
```
如果不配置，系统将使用默认密码：`diary123`

### 2. 重启服务
确保配置生效

## 📝 测试步骤

### 步骤1：创建日记博客
1. 访问博客编辑器 `/editor`
2. 输入标题和内容
3. 在权限设置区域：
   - 选择基础权限（私有或公开）
   - ✅ 勾选"📔 日记权限"
4. 点击保存

### 步骤2：验证权限设置
1. 检查服务器日志，应该看到类似信息：
   ```
   博客 'your_blog_title' 设置了日记权限，AuthType=17
   ```
2. 在博客列表中找到刚创建的博客

### 步骤3：测试访问控制
1. 点击博客链接访问
2. 应该看到密码输入页面，而不是直接显示博客内容
3. 输入错误密码，验证是否显示错误页面
4. 输入正确密码（默认：`diary123`），验证是否正常访问

### 步骤4：测试权限组合
创建不同权限组合的博客：
- **公开 + 日记**：所有人都能看到博客存在，但需要密码访问
- **私有 + 日记**：只有登录用户能看到，且需要额外密码
- **日记 + 加密**：需要日记密码访问，内容还需要解密密码

## 🔍 故障排除

### 问题1：设置了日记权限但没有密码验证
**可能原因：**
- 权限设置未正确保存
- 服务器代码未正确检查 `EAuthType_diary` 标志

**解决方法：**
1. 检查服务器日志是否有权限设置的记录
2. 在浏览器开发者工具中检查权限提交数据
3. 验证数据库中博客的 AuthType 字段值

### 问题2：密码验证页面显示异常
**可能原因：**
- 模板文件缺失或损坏

**解决方法：**
1. 检查 `templates/diary_password.template` 文件是否存在
2. 验证模板语法是否正确

### 问题3：正确密码无法通过验证
**可能原因：**
- 配置文件中的密码设置有误
- 密码比较逻辑错误

**解决方法：**
1. 检查配置文件中的 `diary_password` 设置
2. 尝试使用默认密码 `diary123`
3. 查看服务器日志中的密码验证信息

## 📊 验证成功的标志

✅ **前端界面：**
- 权限设置区域显示正确的复选框状态
- 保存时显示权限摘要包含"📔 日记"
- 点击帮助按钮能看到详细说明

✅ **后端日志：**
- 保存时有"设置了日记权限"的日志记录
- 访问时有"日记博客密码验证成功"的日志记录

✅ **访问控制：**
- 直接访问日记博客会跳转到密码输入页面
- 错误密码会显示错误页面
- 正确密码能正常访问博客内容

## 🎨 用户体验特性

- **智能提示：** 启用日记权限时会显示详细说明
- **权限帮助：** 点击"?"按钮查看权限说明
- **组合权限：** 支持与其他权限类型组合使用
- **美观界面：** 密码输入页面有专门的设计

---

**注意：** 日记权限是系统级别的保护，密码在配置文件中统一设置，不同于博客的个人加密密码。 