<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Book.Title}} - è¯»ä¹¦è¯¦æƒ…</title>
    <link rel="stylesheet" href="/css/reading.css">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/marked/marked.min.js"></script>
    <style>
        .book-detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #faf6f0;
            min-height: 100vh;
        }
        
        .book-header {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #ddd0c0;
        }
        
        .book-cover-large {
            width: 200px;
            height: 300px;
            background: linear-gradient(135deg, #e76f51 0%, #f4a261 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            flex-shrink: 0;
            border: 2px solid #ddd0c0;
        }
        
        .book-cover-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .book-info {
            flex: 1;
        }
        
        .book-title-large {
            font-size: 28px;
            font-weight: bold;
            color: #433520;
            margin-bottom: 10px;
        }
        
        .book-author-large {
            font-size: 18px;
            color: #8b7355;
            margin-bottom: 20px;
        }
        
        .book-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .meta-label {
            font-weight: bold;
            color: #433520;
            min-width: 80px;
        }
        
        .meta-value {
            color: #8b7355;
        }
        
        .book-description {
            background: #f5efe6;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.6;
            color: #433520;
            border: 1px solid #ddd0c0;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd0c0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #8b7355;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #e76f51;
            border-bottom-color: #e76f51;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #ddd0c0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress-section {
            margin-bottom: 30px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .progress-bar-large {
            height: 12px;
            background: #f5efe6;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid #ddd0c0;
        }
        
        .progress-fill-large {
            height: 100%;
            background: linear-gradient(90deg, #e76f51, #f4a261);
            transition: width 0.3s ease;
        }
        
        .progress-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .progress-input {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #ddd0c0;
            border-radius: 4px;
            text-align: center;
            background-color: #ffffff;
        }
        
        .progress-unit {
            font-size: 16px;
            color: #8b7355;
            font-weight: bold;
            margin-left: -5px;
        }
        
        .quick-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .quick-progress-label {
            font-size: 14px;
            color: #8b7355;
            margin-right: 5px;
        }
        
        .btn-quick {
            padding: 4px 8px;
            border: 1px solid #ddd0c0;
            border-radius: 4px;
            background: #f5efe6;
            color: #433520;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-quick:hover {
            background: #e76f51;
            color: white;
            border-color: #e76f51;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #e76f51;
            color: white;
        }
        
        .btn-primary:hover {
            background: #f4a261;
        }
        
        .btn-success {
            background: #6b9080;
            color: white;
        }
        
        .btn-success:hover {
            background: #5a7c6f;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
            line-height: 1.4;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
            width: 100%;
            padding: 10px 0;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.hide {
            display: none;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #ddd0c0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #433520;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #8b7355;
        }
        
        .modal-close:hover {
            color: #e76f51;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #ddd0c0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        /* å°é¢é¢„è§ˆæ ·å¼ */
        .cover-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f5efe6;
            border-radius: 4px;
            border: 1px solid #ddd0c0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-label {
            font-size: 12px;
            color: #8b7355;
            font-weight: 500;
        }
        
        .preview-error {
            font-size: 12px;
            color: #e63946;
        }
        
        /* URLè¾“å…¥ç»„æ ·å¼ */
        .url-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .url-input-group .form-input {
            flex: 1;
        }
        
        .test-url-btn {
            padding: 8px 12px;
            white-space: nowrap;
            font-size: 12px;
        }
        
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .note-item {
            background: #f5efe6;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e76f51;
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .note-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .note-location {
            font-size: 12px;
            color: #8b7355;
        }
        
        .note-actions,
        .insight-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .note-item:hover .note-actions,
        .insight-item:hover .insight-actions {
            opacity: 1;
        }
        
        .btn-action {
            padding: 4px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            background: transparent;
        }
        
        .btn-action:hover {
            transform: scale(1.1);
        }
        
        .btn-action.btn-edit {
            color: #f39c12;
        }
        
        .btn-action.btn-edit:hover {
            background: rgba(243, 156, 18, 0.1);
        }
        
        .btn-action.btn-delete {
            color: #e74c3c;
        }
        
        .btn-action.btn-delete:hover {
            background: rgba(231, 76, 60, 0.1);
        }
        
        .note-content {
            line-height: 1.6;
            color: #433520;
        }
        
        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .insight-item {
            background: #f5efe6;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #e9c46a;
        }
        
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .insight-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .insight-title {
            font-weight: bold;
            color: #433520;
        }
        
        .insight-rating {
            color: #e9c46a;
        }
        
        .insight-content {
            line-height: 1.6;
            color: #433520;
            margin-bottom: 10px;
        }
        
        .insight-takeaway {
            background: #eadbc8;
            padding: 10px;
            border-radius: 4px;
            font-style: italic;
            color: #8b7355;
        }
        
        /* Markdownå†…å®¹æ ·å¼ */
        .markdown-content {
            line-height: 1.6;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            color: #433520;
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
        
        .markdown-content h1 { font-size: 1.8em; }
        .markdown-content h2 { font-size: 1.6em; }
        .markdown-content h3 { font-size: 1.4em; }
        .markdown-content h4 { font-size: 1.2em; }
        .markdown-content h5 { font-size: 1.1em; }
        .markdown-content h6 { font-size: 1em; }
        
        .markdown-content p {
            margin: 0.8em 0;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin: 0.8em 0;
            padding-left: 2em;
        }
        
        .markdown-content li {
            margin: 0.3em 0;
        }
        
        .markdown-content blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            border-left: 4px solid #e76f51;
            background: #f5efe6;
            color: #8b7355;
            font-style: italic;
        }
        
        .markdown-content code {
            background: #f5efe6;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #e76f51;
            border: 1px solid #ddd0c0;
        }
        
        .markdown-content pre {
            background: #f5efe6;
            padding: 1em;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #ddd0c0;
            margin: 1em 0;
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
            border: none;
            color: #433520;
        }
        
        .markdown-content strong {
            color: #433520;
            font-weight: bold;
        }
        
        .markdown-content em {
            color: #8b7355;
            font-style: italic;
        }
        
        .markdown-content a {
            color: #e76f51;
            text-decoration: none;
        }
        
        .markdown-content a:hover {
            color: #f4a261;
            text-decoration: underline;
        }
        
        .markdown-content hr {
            border: none;
            border-top: 2px solid #ddd0c0;
            margin: 2em 0;
        }
        
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        .markdown-content th,
        .markdown-content td {
            border: 1px solid #ddd0c0;
            padding: 0.5em;
            text-align: left;
        }
        
        .markdown-content th {
            background: #f5efe6;
            font-weight: bold;
            color: #433520;
        }
        
        /* Markdownæç¤ºæ ·å¼ */
        .markdown-tip {
            font-size: 12px;
            color: #8b7355;
            margin-top: 10px;
            padding: 8px 12px;
            background: #f5efe6;
            border-radius: 4px;
            border-left: 3px solid #e76f51;
        }
        
        .markdown-tip code {
            background: #eadbc8;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 11px;
        }
        
        .add-form {
            background: #f5efe6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd0c0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #433520;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd0c0;
            border-radius: 4px;
            font-size: 14px;
            background-color: #ffffff;
        }
        
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd0c0;
            border-radius: 4px;
            font-size: 14px;
            background-color: #ffffff;
            resize: vertical;
            line-height: 1.5;
            font-family: inherit;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #e76f51;
            box-shadow: 0 0 0 3px rgba(231, 111, 81, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #e76f51;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(231, 111, 81, 0.3);
            white-space: nowrap;
            display: inline-block;
            width: auto;
        }
        
        .back-btn:hover {
            background: #f4a261;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 111, 81, 0.4);
        }
        
        .back-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(231, 111, 81, 0.3);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #8b7355;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
        }
        
        @media (max-width: 768px) {
            .book-header {
                flex-direction: column;
                text-align: center;
            }
            
            .book-cover-large {
                width: 150px;
                height: 225px;
                margin: 0 auto;
            }
            
            .book-meta {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .progress-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-progress {
                justify-content: center;
                margin-top: 15px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .back-btn {
                top: 15px;
                left: 15px;
                padding: 6px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
        <!-- éšè—çš„æ•°æ®å®¹å™¨ï¼Œç”¨äºä¼ é€’åç«¯æ•°æ®ç»™JavaScript -->
        <div id="book-data" 
             data-book-id="{{.Book.ID}}"
             data-current-page="{{.Book.CurrentPage}}" 
             data-total-pages="{{.Book.TotalPages}}"
             data-book-rating="{{.Book.Rating}}"
             data-book-title="{{.Book.Title}}"
             data-book-author="{{.Book.Author}}"
             data-book-isbn="{{.Book.ISBN}}"
             data-book-publisher="{{.Book.Publisher}}"
             data-book-publish-date="{{.Book.PublishDate}}"
             data-book-cover-url="{{.Book.CoverUrl}}"
             data-book-description="{{.Book.Description}}"
             data-book-source-url="{{.Book.SourceUrl}}"
             data-book-category="{{range $i, $cat := .Book.Category}}{{if $i}}, {{end}}{{$cat}}{{end}}"
             data-book-tags="{{range $i, $tag := .Book.Tags}}{{if $i}}, {{end}}{{$tag}}{{end}}"
             style="display: none;">
        </div>
    <button class="back-btn" onclick="window.history.back()">â† è¿”å›ä¹¦åº“</button>
    
    <div class="book-detail-container">
        <!-- ä¹¦ç±å¤´éƒ¨ä¿¡æ¯ -->
        <div class="book-header">
            <div class="book-cover-large" id="book-cover-container">
                {{if .Book.CoverUrl}}
                    <img src="{{.Book.CoverUrl}}" alt="{{.Book.Title}}" 
                         onerror="try { handleImageError(this); } catch(e) { console.error('Error in handleImageError:', e); this.style.display='none'; }" 
                         onload="console.log('å°é¢å›¾ç‰‡åŠ è½½æˆåŠŸ')"
                         style="width: 100%; height: 100%; object-fit: cover;">
                {{else}}
                    <div style="font-size: 48px; color: white; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">ğŸ“š</div>
                {{end}}
            </div>
            <div class="book-info">
                <h1 class="book-title-large">{{.Book.Title}}</h1>
                <p class="book-author-large">{{.Book.Author}}</p>
                
                <div class="book-meta">
                    <div class="meta-item">
                        <span class="meta-label">çŠ¶æ€:</span>
                        <span class="meta-value status-{{.Book.Status}}">
                            {{if eq .Book.Status "unstart"}}æœªå¼€å§‹
                            {{else if eq .Book.Status "reading"}}é˜…è¯»ä¸­
                            {{else if eq .Book.Status "finished"}}å·²å®Œæˆ
                            {{else if eq .Book.Status "paused"}}æš‚åœ
                            {{else}}æœªçŸ¥{{end}}
                        </span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">å‡ºç‰ˆç¤¾:</span>
                        <span class="meta-value">{{.Book.Publisher}}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ISBN:</span>
                        <span class="meta-value">{{.Book.ISBN}}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">é¡µæ•°:</span>
                        <span class="meta-value">{{.Book.TotalPages}}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">è¯„åˆ†:</span>
                        <span class="meta-value" id="book-rating">
                            {{if .Book.Rating}}
                                {{.Book.Rating}}
                            {{else}}
                                æœªè¯„åˆ†
                            {{end}}
                        </span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">åˆ†ç±»:</span>
                        <span class="meta-value">
                            {{range $i, $cat := .Book.Category}}
                                {{if $i}}, {{end}}{{$cat}}
                            {{end}}
                        </span>
                    </div>
                </div>
                
                {{if .Book.Description}}
                <div class="book-description">
                    {{.Book.Description}}
                </div>
                {{end}}
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('progress')">é˜…è¯»è¿›åº¦</button>
            <button class="tab" onclick="switchTab('notes')">è¯»ä¹¦ç¬”è®°</button>
            <button class="tab" onclick="switchTab('insights')">è¯»ä¹¦å¿ƒå¾—</button>
        </div>
        
        <!-- é˜…è¯»è¿›åº¦æ ‡ç­¾é¡µ -->
        <div id="progress-tab" class="tab-content active">
            <div class="progress-section">
                <div class="progress-info">
                    <span>é˜…è¯»è¿›åº¦</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress-bar-large">
                    <div class="progress-fill-large" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-controls">
                    <input type="number" class="progress-input" id="current-progress" value="0" min="0" max="100" step="1" placeholder="è¾“å…¥ç™¾åˆ†æ¯”">
                    <span class="progress-unit">%</span>
                    <button class="btn btn-primary" onclick="updateProgress()">æ›´æ–°è¿›åº¦</button>
                    <button class="btn btn-success" onclick="markAsFinished()">æ ‡è®°å®Œæˆ</button>
                </div>
                
                <div class="quick-progress">
                    <span class="quick-progress-label">å¿«æ·è®¾ç½®ï¼š</span>
                    <button class="btn-quick" onclick="setQuickProgress(25)">25%</button>
                    <button class="btn-quick" onclick="setQuickProgress(50)">50%</button>
                    <button class="btn-quick" onclick="setQuickProgress(75)">75%</button>
                    <button class="btn-quick" onclick="setQuickProgress(100)">100%</button>
                </div>
            </div>
        </div>
        
        <!-- è¯»ä¹¦ç¬”è®°æ ‡ç­¾é¡µ -->
        <div id="notes-tab" class="tab-content">
            <div class="add-form">
                <h3>æ·»åŠ ç¬”è®°</h3>
                <form id="add-note-form">
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">ç« èŠ‚</label>
                            <input type="text" class="form-input" id="note-chapter" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç« ">
                        </div>
                        <div class="form-col">
                            <label class="form-label">é¡µç </label>
                            <input type="number" class="form-input" id="note-page" placeholder="é¡µç ">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç¬”è®°å†…å®¹</label>
                        <textarea class="form-textarea" id="note-content" placeholder="è®°å½•ä½ çš„æƒ³æ³•ã€æ‘˜å½•æˆ–æ€»ç»“..." rows="4"></textarea>
                        <div class="markdown-tip">
                            ğŸ’¡ æ”¯æŒ <strong>Markdown</strong> æ ¼å¼ï¼š<code>**ç²—ä½“**</code> <code>*æ–œä½“*</code> <code>`ä»£ç `</code> <code>- åˆ—è¡¨</code> <code>&gt; å¼•ç”¨</code>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ ç¬”è®°</button>
                </form>
            </div>
            
            <div class="notes-list" id="notes-list">
                <div class="empty-state">
                    <i>ğŸ“</i>
                    <p>è¿˜æ²¡æœ‰ç¬”è®°ï¼Œå¼€å§‹è®°å½•ä½ çš„é˜…è¯»å¿ƒå¾—å§ï¼</p>
                </div>
            </div>
        </div>
        
        <!-- è¯»ä¹¦å¿ƒå¾—æ ‡ç­¾é¡µ -->
        <div id="insights-tab" class="tab-content">
            <div class="add-form">
                <h3>æ·»åŠ å¿ƒå¾—</h3>
                <form id="add-insight-form">
                    <div class="form-group">
                        <label class="form-label">å¿ƒå¾—æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="insight-title" placeholder="ç»™ä½ çš„å¿ƒå¾—èµ·ä¸ªæ ‡é¢˜">
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">è¯„åˆ†</label>
                            <select class="form-input" id="insight-rating">
                                <option value="1">â­</option>
                                <option value="2">â­â­</option>
                                <option value="3">â­â­â­</option>
                                <option value="4">â­â­â­â­</option>
                                <option value="5">â­â­â­â­â­</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label class="form-label">ç±»å‹</label>
                            <select class="form-input" id="insight-type">
                                <option value="summary">æ€»ç»“</option>
                                <option value="reflection">åæ€</option>
                                <option value="analysis">åˆ†æ</option>
                                <option value="application">åº”ç”¨</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¿ƒå¾—å†…å®¹</label>
                        <textarea class="form-textarea" id="insight-content" placeholder="åˆ†äº«ä½ çš„æ·±åº¦æ€è€ƒå’Œæ„Ÿæ‚Ÿ..." rows="5"></textarea>
                        <div class="markdown-tip">
                            ğŸ’¡ æ”¯æŒ <strong>Markdown</strong> æ ¼å¼ï¼š<code>**ç²—ä½“**</code> <code>*æ–œä½“*</code> <code>`ä»£ç `</code> <code>## æ ‡é¢˜</code> <code>- åˆ—è¡¨</code> <code>&gt; å¼•ç”¨</code>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å…³é”®æ”¶è·</label>
                        <textarea class="form-textarea" id="insight-takeaway" placeholder="è¿™æœ¬ä¹¦ç»™ä½ å¸¦æ¥äº†ä»€ä¹ˆå¯å‘æˆ–æ”¹å˜ï¼Ÿ" rows="3"></textarea>
                        <div class="markdown-tip">
                            ğŸ’¡ æ”¯æŒ <strong>Markdown</strong> æ ¼å¼ï¼šè®°å½•å…³é”®æ”¶è·å’Œå¯å‘
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ å¿ƒå¾—</button>
                </form>
            </div>
            
            <div class="insights-list" id="insights-list">
                <div class="empty-state">
                    <i>ğŸ’¡</i>
                    <p>è¿˜æ²¡æœ‰å¿ƒå¾—ï¼Œåˆ†äº«ä½ çš„æ·±åº¦æ€è€ƒå§ï¼</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘ä¹¦ç±æ¨¡æ€æ¡† -->
    <div id="edit-book-modal" class="modal hide">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœï¸ ç¼–è¾‘ä¹¦ç±</h3>
                <button class="modal-close" onclick="hideEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-book-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-book-title">ä¹¦å *</label>
                            <input type="text" id="edit-book-title" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-book-author">ä½œè€… *</label>
                            <input type="text" id="edit-book-author" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-book-isbn">ISBN</label>
                            <input type="text" id="edit-book-isbn" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="edit-book-publisher">å‡ºç‰ˆç¤¾</label>
                            <input type="text" id="edit-book-publisher" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-book-publish-date">å‡ºç‰ˆæ—¥æœŸ</label>
                            <input type="date" id="edit-book-publish-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="edit-book-total-pages">æ€»é¡µæ•°</label>
                            <input type="number" id="edit-book-total-pages" class="form-input" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-book-cover-url">å°é¢å›¾ç‰‡URL</label>
                        <div class="url-input-group">
                            <input type="url" id="edit-book-cover-url" class="form-input" placeholder="è¯·è¾“å…¥å›¾ç‰‡URL">
                            <button type="button" class="btn btn-secondary test-url-btn" onclick="previewCoverImage()">æµ‹è¯•</button>
                        </div>
                        <div id="cover-preview" class="cover-preview hide">
                            <div class="preview-label">é¢„è§ˆï¼š</div>
                            <img id="preview-img" style="max-width: 100px; max-height: 150px; border-radius: 4px;">
                            <div id="preview-error" class="preview-error hide">âŒ å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-book-description">ç®€ä»‹</label>
                        <textarea id="edit-book-description" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-book-category">åˆ†ç±»æ ‡ç­¾</label>
                            <input type="text" id="edit-book-category" class="form-input" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šæŠ€æœ¯,ç¼–ç¨‹">
                        </div>
                        <div class="form-group">
                            <label for="edit-book-tags">è‡ªå®šä¹‰æ ‡ç­¾</label>
                            <input type="text" id="edit-book-tags" class="form-input" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šå®ç”¨,è¿›é˜¶">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-book-source-url">æ¥æºURL</label>
                        <input type="url" id="edit-book-source-url" class="form-input" placeholder="è±†ç“£ã€äºšé©¬é€Šç­‰é“¾æ¥">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideEditModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitEditBook()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        // ä»æ•°æ®å®¹å™¨è·å–ä¹¦ç±åŸºæœ¬ä¿¡æ¯
        const bookDataElement = document.getElementById('book-data');
        const bookId = bookDataElement.getAttribute('data-book-id');
        const totalPages = parseInt(bookDataElement.getAttribute('data-total-pages')) || 0;
        
        // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
        function handleImageError(img) {
            try {
                const imgSrc = img ? img.src : 'unknown';
                console.log('å°é¢å›¾ç‰‡åŠ è½½å¤±è´¥:', imgSrc);
                
                // æ£€æŸ¥imgå’Œå…¶çˆ¶å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!img || !img.parentElement) {
                    console.error('å›¾ç‰‡å…ƒç´ æˆ–å…¶çˆ¶å®¹å™¨ä¸å­˜åœ¨');
                    return;
                }
                
                const container = img.parentElement;
                if (!container) {
                    console.error('çˆ¶å®¹å™¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ›¿æ¢å›¾ç‰‡');
                    return;
                }
                
                // åˆ›å»ºæ›¿æ¢çš„å›¾æ ‡å…ƒç´ 
                const iconDiv = document.createElement('div');
                iconDiv.className = 'image-error-placeholder';
                iconDiv.style.cssText = `
                    font-size: 48px;
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #e76f51, #f4a261);
                    border-radius: 8px;
                    flex-direction: column;
                    gap: 8px;
                `;
                
                // æ·»åŠ å›¾æ ‡å’Œæç¤ºæ–‡å­—
                const icon = document.createElement('div');
                icon.style.fontSize = '48px';
                icon.textContent = 'ğŸ“š';
                
                const text = document.createElement('div');
                text.style.cssText = `
                    font-size: 12px;
                    color: rgba(255, 255, 255, 0.8);
                    text-align: center;
                    font-weight: 500;
                `;
                text.textContent = 'å°é¢åŠ è½½å¤±è´¥';
                
                iconDiv.appendChild(icon);
                iconDiv.appendChild(text);
                
                // æ¸…ç©ºçˆ¶å®¹å™¨å¹¶æ·»åŠ å›¾æ ‡
                container.innerHTML = '';
                container.appendChild(iconDiv);
                
                console.log('å·²æ›¿æ¢ä¸ºé»˜è®¤å›¾æ ‡');
                
            } catch (error) {
                console.error('handleImageError å‘ç”Ÿé”™è¯¯:', error);
                
                // å¦‚æœå‡ºç°é”™è¯¯ï¼Œå°è¯•ç®€å•çš„å¤„ç†æ–¹å¼
                if (img && img.style) {
                    img.style.display = 'none';
                }
                
                // å°è¯•åœ¨çˆ¶å®¹å™¨ä¸­æ˜¾ç¤ºç®€å•çš„æ›¿ä»£å†…å®¹
                try {
                    const container = img.parentElement;
                    if (container) {
                        container.innerHTML = '<div style="font-size: 48px; color: white; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; background: #e76f51; border-radius: 8px;">ğŸ“š</div>';
                    }
                } catch (e) {
                    console.error('å¤‡ç”¨å¤„ç†æ–¹å¼ä¹Ÿå¤±è´¥:', e);
                }
            }
        }
        
        // æ£€æŸ¥å›¾ç‰‡URLæœ‰æ•ˆæ€§
        function checkImageUrl(url) {
            if (!url || url.trim() === '') {
                return false;
            }
            
            // åŸºæœ¬çš„URLæ ¼å¼æ£€æŸ¥
            try {
                const urlObj = new URL(url);
                
                // æ£€æŸ¥åè®®
                if (!['http:', 'https:'].includes(urlObj.protocol)) {
                    console.warn('å›¾ç‰‡URLåè®®ä¸æ”¯æŒ:', urlObj.protocol);
                    return false;
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¸¸è§çš„å›¾ç‰‡æ–‡ä»¶æ‰©å±•å
                const pathname = urlObj.pathname.toLowerCase();
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];
                const hasImageExtension = imageExtensions.some(ext => pathname.endsWith(ext));
                
                // å¦‚æœæ²¡æœ‰å›¾ç‰‡æ‰©å±•åï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºå¸¸è§çš„å›¾ç‰‡æœåŠ¡åŸŸå
                if (!hasImageExtension) {
                    const hostname = urlObj.hostname.toLowerCase();
                    const imageServices = [
                        'bkimg.cdn.bcebos.com',
                        'img.douban.com',
                        'images.amazon.com',
                        'cover.read.duokan.com',
                        'img1.doubanio.com',
                        'img2.doubanio.com',
                        'img3.doubanio.com',
                        'img9.doubanio.com'
                    ];
                    
                    const isKnownImageService = imageServices.some(service => hostname.includes(service));
                    if (!isKnownImageService) {
                        console.warn('å›¾ç‰‡URLå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥ (æ— å›¾ç‰‡æ‰©å±•åä¸”éå·²çŸ¥å›¾ç‰‡æœåŠ¡):', url);
                    }
                }
                
                return true;
            } catch (e) {
                console.warn('æ— æ•ˆçš„å›¾ç‰‡URLæ ¼å¼:', url, e.message);
                return false;
            }
        }
        
        // é¢„åŠ è½½å›¾ç‰‡ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        function preloadImage(url, callback, retryCount = 0) {
            const maxRetries = 2;
            const retryDelay = 1000; // 1ç§’åé‡è¯•
            
            try {
                if (!checkImageUrl(url)) {
                    console.warn('å›¾ç‰‡URLæ ¼å¼æ— æ•ˆ:', url);
                    if (callback) callback(false);
                    return;
                }
                
                // æ£€æŸ¥å¸¸è§çš„å›¾ç‰‡URLé—®é¢˜
                if (url.includes('bkimg.cdn.bcebos.com') || url.includes('baike.baidu.com')) {
                    console.warn('æ£€æµ‹åˆ°ç™¾åº¦å›¾ç‰‡é“¾æ¥ï¼Œå¯èƒ½å­˜åœ¨è·¨åŸŸæˆ–é˜²ç›—é“¾é—®é¢˜:', url);
                }
                
                const img = new Image();
                let isCompleted = false;
                
                // æˆåŠŸåŠ è½½å¤„ç†
                img.onload = function() {
                    if (isCompleted) return;
                    isCompleted = true;
                    
                    console.log('å›¾ç‰‡é¢„åŠ è½½æˆåŠŸ:', url);
                    if (callback) callback(true);
                };
                
                // åŠ è½½å¤±è´¥å¤„ç†
                img.onerror = function() {
                    if (isCompleted) return;
                    isCompleted = true;
                    
                    console.warn(`å›¾ç‰‡é¢„åŠ è½½å¤±è´¥ (å°è¯• ${retryCount + 1}/${maxRetries + 1}):`, url);
                    
                    // é‡è¯•é€»è¾‘
                    if (retryCount < maxRetries) {
                        console.log(`${retryDelay}msåé‡è¯•...`);
                        setTimeout(() => {
                            preloadImage(url, callback, retryCount + 1);
                        }, retryDelay);
                    } else {
                        console.error('å›¾ç‰‡é¢„åŠ è½½æœ€ç»ˆå¤±è´¥:', url);
                        if (callback) callback(false);
                    }
                };
                
                // è®¾ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
                const timeoutId = setTimeout(() => {
                    if (isCompleted) return;
                    isCompleted = true;
                    
                    console.warn(`å›¾ç‰‡åŠ è½½è¶…æ—¶ (å°è¯• ${retryCount + 1}/${maxRetries + 1}):`, url);
                    
                    // é‡è¯•é€»è¾‘
                    if (retryCount < maxRetries) {
                        console.log(`${retryDelay}msåé‡è¯•...`);
                        setTimeout(() => {
                            preloadImage(url, callback, retryCount + 1);
                        }, retryDelay);
                    } else {
                        console.error('å›¾ç‰‡åŠ è½½æœ€ç»ˆè¶…æ—¶:', url);
                        if (callback) callback(false);
                    }
                }, 8000); // 8ç§’è¶…æ—¶
                
                // å°è¯•åŠ è½½å›¾ç‰‡
                img.src = url;
                
            } catch (error) {
                console.error('preloadImage å‘ç”Ÿé”™è¯¯:', error, 'URL:', url);
                if (callback) callback(false);
            }
        }
        
        // å¿«æ·è®¾ç½®è¿›åº¦
        function setQuickProgress(percent) {
            document.getElementById('current-progress').value = percent;
            updateProgress();
        }
        
        // å°†é¡µæ•°è½¬æ¢ä¸ºç™¾åˆ†æ¯”
        function pageToPercent(page) {
            return totalPages > 0 ? (page / totalPages) * 100 : 0;
        }
        
        // å°†ç™¾åˆ†æ¯”è½¬æ¢ä¸ºé¡µæ•°
        function percentToPage(percent) {
            return Math.round((percent / 100) * totalPages);
        }
        
        // ç¼–è¾‘ä¹¦ç±åŠŸèƒ½
        function editBook() {
            showEditModal();
        }
        
        // åˆ é™¤ä¹¦ç±åŠŸèƒ½
        async function deleteBook() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åŒæ—¶åˆ é™¤æ‰€æœ‰ç›¸å…³çš„ç¬”è®°å’Œå¿ƒå¾—ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/books?book_id=${bookId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('åˆ é™¤ä¹¦ç±å¤±è´¥');
                }
                
                showToast('ä¹¦ç±å·²æˆåŠŸåˆ é™¤ï¼', 'success');
                
                // ç­‰å¾…ä¸€ä¸‹å†è·³è½¬
                setTimeout(() => {
                    window.location.href = '/reading';
                }, 1500);
                
            } catch (error) {
                console.error('åˆ é™¤ä¹¦ç±å¤±è´¥:', error);
                showToast('åˆ é™¤ä¹¦ç±å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // é¢„è§ˆå°é¢å›¾ç‰‡
        function previewCoverImage() {
            try {
                const urlInput = document.getElementById('edit-book-cover-url');
                const preview = document.getElementById('cover-preview');
                const previewImg = document.getElementById('preview-img');
                const previewError = document.getElementById('preview-error');
                
                // æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!urlInput || !preview || !previewImg || !previewError) {
                    console.error('é¢„è§ˆç›¸å…³çš„DOMå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                const url = urlInput.value.trim();
                
                if (!url) {
                    preview.classList.add('hide');
                    return;
                }
                
                previewError.classList.add('hide');
                preview.classList.remove('hide');
                
                preloadImage(url, (success) => {
                    // å†æ¬¡æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼ˆé˜²æ­¢å¼‚æ­¥å›è°ƒæ—¶å…ƒç´ è¢«ç§»é™¤ï¼‰
                    if (!previewImg || !previewError) {
                        console.error('é¢„è§ˆå…ƒç´ åœ¨å›è°ƒæ—¶ä¸å­˜åœ¨');
                        return;
                    }
                    
                    if (success) {
                        previewImg.src = url;
                        previewImg.style.display = 'block';
                        previewError.classList.add('hide');
                    } else {
                        previewImg.style.display = 'none';
                        previewError.classList.remove('hide');
                    }
                });
            } catch (error) {
                console.error('previewCoverImage å‘ç”Ÿé”™è¯¯:', error);
            }
        }
        
        // æ›´æ–°ä¸»é¡µé¢å°é¢å›¾ç‰‡
        function updateMainCoverImage(newUrl) {
            const container = document.getElementById('book-cover-container');
            
            if (!container) {
                console.error('å°é¢å®¹å™¨ä¸å­˜åœ¨');
                return;
            }
            
            if (!newUrl || newUrl.trim() === '') {
                // å¦‚æœæ²¡æœ‰URLï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                container.innerHTML = '<div style="font-size: 48px; color: white; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">ğŸ“š</div>';
                return;
            }
            
            // é¢„åŠ è½½æ–°å›¾ç‰‡
            preloadImage(newUrl, (success) => {
                if (!container) return; // å†æ¬¡æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
                
                if (success) {
                    // å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œæ›´æ–°æ˜¾ç¤º
                    const imgHtml = `<img src="${newUrl.replace(/"/g, '&quot;')}" alt="ä¹¦ç±å°é¢" style="width: 100%; height: 100%; object-fit: cover;" onerror="handleImageError(this)">`;
                    container.innerHTML = imgHtml;
                } else {
                    // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                    container.innerHTML = '<div style="font-size: 48px; color: white; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">ğŸ“š</div>';
                }
            });
        }
        
        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        function showEditModal() {
            const modal = document.getElementById('edit-book-modal');
            
            // å¡«å……å½“å‰ä¹¦ç±ä¿¡æ¯
            const bookData = document.getElementById('book-data');
            document.getElementById('edit-book-title').value = bookData.getAttribute('data-book-title') || '';
            document.getElementById('edit-book-author').value = bookData.getAttribute('data-book-author') || '';
            document.getElementById('edit-book-isbn').value = bookData.getAttribute('data-book-isbn') || '';
            document.getElementById('edit-book-publisher').value = bookData.getAttribute('data-book-publisher') || '';
            document.getElementById('edit-book-publish-date').value = bookData.getAttribute('data-book-publish-date') || '';
            document.getElementById('edit-book-total-pages').value = bookData.getAttribute('data-total-pages') || '';
            document.getElementById('edit-book-cover-url').value = bookData.getAttribute('data-book-cover-url') || '';
            document.getElementById('edit-book-description').value = bookData.getAttribute('data-book-description') || '';
            document.getElementById('edit-book-category').value = bookData.getAttribute('data-book-category') || '';
            document.getElementById('edit-book-tags').value = bookData.getAttribute('data-book-tags') || '';
            document.getElementById('edit-book-source-url').value = bookData.getAttribute('data-book-source-url') || '';
            
            modal.classList.remove('hide');
            
            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    hideEditModal();
                }
            });
            
            // æ·»åŠ ESCé”®å…³é—­åŠŸèƒ½
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !modal.classList.contains('hide')) {
                    hideEditModal();
                }
            });
        }
        
        // éšè—ç¼–è¾‘æ¨¡æ€æ¡†
        function hideEditModal() {
            const modal = document.getElementById('edit-book-modal');
            modal.classList.add('hide');
            
            // æ¸…é™¤URLä¸­çš„editå‚æ•°
            const url = new URL(window.location);
            url.searchParams.delete('edit');
            window.history.replaceState({}, '', url);
        }
        
        // æäº¤ç¼–è¾‘ä¹¦ç±
        async function submitEditBook() {
            const bookData = {
                title: document.getElementById('edit-book-title').value,
                author: document.getElementById('edit-book-author').value,
                isbn: document.getElementById('edit-book-isbn').value,
                publisher: document.getElementById('edit-book-publisher').value,
                publish_date: document.getElementById('edit-book-publish-date').value,
                total_pages: parseInt(document.getElementById('edit-book-total-pages').value) || 0,
                cover_url: document.getElementById('edit-book-cover-url').value,
                description: document.getElementById('edit-book-description').value,
                category: document.getElementById('edit-book-category').value.split(',').map(s => s.trim()).filter(s => s),
                tags: document.getElementById('edit-book-tags').value.split(',').map(s => s.trim()).filter(s => s),
                source_url: document.getElementById('edit-book-source-url').value
            };
            
            if (!bookData.title || !bookData.author) {
                showToast('è¯·å¡«å†™ä¹¦åå’Œä½œè€…', 'error');
                return;
            }
            
            try {
                showToast('æ­£åœ¨ä¿å­˜ä¿®æ”¹...', 'info');
                
                const response = await fetch(`/api/books?book_id=${bookId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookData)
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                
                showToast('ä¹¦ç±ä¿¡æ¯å·²æˆåŠŸæ›´æ–°ï¼', 'success');
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯åˆ·æ–°æ•´ä¸ªé¡µé¢
                const result = await response.json();
                if (result.book) {
                    // æ›´æ–°å°é¢å›¾ç‰‡
                    updateMainCoverImage(result.book.cover_url);
                    
                    // æ›´æ–°ä¹¦ç±æ ‡é¢˜
                    const titleElement = document.querySelector('.book-title-large');
                    if (titleElement) titleElement.textContent = result.book.title;
                    
                    // æ›´æ–°ä½œè€…
                    const authorElement = document.querySelector('.book-author-large');
                    if (authorElement) authorElement.textContent = result.book.author;
                    
                    // æ›´æ–°å…¶ä»–å…ƒä¿¡æ¯
                    const metaValues = document.querySelectorAll('.meta-value');
                    if (metaValues.length >= 6) {
                        metaValues[1].textContent = result.book.publisher || '';
                        metaValues[2].textContent = result.book.isbn || '';
                        metaValues[3].textContent = result.book.total_pages || '';
                        if (result.book.category && result.book.category.length > 0) {
                            metaValues[5].textContent = result.book.category.join(', ');
                        }
                    }
                    
                    // æ›´æ–°ç®€ä»‹
                    const descElement = document.querySelector('.book-description');
                    if (descElement) {
                        if (result.book.description) {
                            descElement.textContent = result.book.description;
                            descElement.style.display = 'block';
                        } else {
                            descElement.style.display = 'none';
                        }
                    }
                }
                
                hideEditModal();
                
            } catch (error) {
                console.error('æ›´æ–°ä¹¦ç±å¤±è´¥:', error);
                showToast('æ›´æ–°ä¹¦ç±å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'notes') {
                loadNotes();
            } else if (tabName === 'insights') {
                loadInsights();
            }
        }
        
        // æ›´æ–°é˜…è¯»è¿›åº¦
        async function updateProgress() {
            const progressPercent = parseFloat(document.getElementById('current-progress').value);
            if (progressPercent < 0 || progressPercent > 100) {
                alert('è¿›åº¦ç™¾åˆ†æ¯”è¶…å‡ºèŒƒå›´ï¼ˆ0-100ï¼‰');
                return;
            }
            
            // å°†ç™¾åˆ†æ¯”è½¬æ¢ä¸ºé¡µæ•°
            const currentPage = percentToPage(progressPercent);
            
            try {
                const response = await fetch(`/api/books/progress?book_id=${bookId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_page: currentPage
                    })
                });
                
                if (!response.ok) {
                    throw new Error('æ›´æ–°è¿›åº¦å¤±è´¥');
                }
                
                // æ›´æ–°è¿›åº¦æ¡å’Œæ–‡æœ¬
                document.getElementById('progress-fill').style.width = progressPercent + '%';
                document.getElementById('progress-text').textContent = progressPercent.toFixed(1) + '%';
                
                showToast(`è¿›åº¦æ›´æ–°æˆåŠŸï¼(${currentPage}/${totalPages}é¡µ)`, 'success');
                
            } catch (error) {
                console.error('æ›´æ–°è¿›åº¦å¤±è´¥:', error);
                showToast('æ›´æ–°è¿›åº¦å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ ‡è®°ä¸ºå®Œæˆ
        async function markAsFinished() {
            try {
                const response = await fetch(`/api/books/finish?book_id=${bookId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('æ ‡è®°å®Œæˆå¤±è´¥');
                }
                
                // æ›´æ–°é¡µé¢çŠ¶æ€
                document.getElementById('current-progress').value = 100;
                document.getElementById('progress-fill').style.width = '100%';
                document.getElementById('progress-text').textContent = '100%';
                
                showToast('æ­å–œå®Œæˆè¿™æœ¬ä¹¦ï¼', 'success');
                
            } catch (error) {
                console.error('æ ‡è®°å®Œæˆå¤±è´¥:', error);
                showToast('æ ‡è®°å®Œæˆå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½ç¬”è®°
        async function loadNotes() {
            try {
                const response = await fetch(`/api/books/notes?book_id=${bookId}`);
                if (!response.ok) {
                    throw new Error('åŠ è½½ç¬”è®°å¤±è´¥');
                }
                
                const notes = await response.json();
                displayNotes(notes);
                
            } catch (error) {
                console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºç¬”è®°
        function displayNotes(notes) {
            const notesList = document.getElementById('notes-list');
            
            if (!notes || notes.length === 0) {
                notesList.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ“</i>
                        <p>è¿˜æ²¡æœ‰ç¬”è®°ï¼Œå¼€å§‹è®°å½•ä½ çš„é˜…è¯»å¿ƒå¾—å§ï¼</p>
                        <p class="markdown-tip">ğŸ’¡ æ”¯æŒ <strong>Markdown</strong> æ ¼å¼ï¼š<code>**ç²—ä½“**</code> <code>*æ–œä½“*</code> <code>\`ä»£ç \`</code> ç­‰</p>
                    </div>
                `;
                return;
            }
            
            notesList.innerHTML = notes.map(note => `
                <div class="note-item" data-note-id="${note.id}">
                    <div class="note-header">
                        <span class="note-location">${note.chapter || ''}${note.page ? ' - ç¬¬' + note.page + 'é¡µ' : ''}</span>
                        <div class="note-header-right">
                            <span class="note-time">${formatDate(note.create_time)}</span>
                            <div class="note-actions">
                                <button class="btn-action btn-edit" onclick="editNote('${note.id}', '${note.chapter || ''}', ${note.page || 0}, \`${escapeForJS(note.content)}\`)" title="ç¼–è¾‘">âœï¸</button>
                                <button class="btn-action btn-delete" onclick="deleteNote('${note.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                    <div class="note-content markdown-content">${renderMarkdown(note.content)}</div>
                </div>
            `).join('');
        }
        
        // åŠ è½½å¿ƒå¾—
        async function loadInsights() {
            try {
                const response = await fetch(`/api/books/insights?book_id=${bookId}`);
                if (!response.ok) {
                    throw new Error('åŠ è½½å¿ƒå¾—å¤±è´¥');
                }
                
                const insights = await response.json();
                displayInsights(insights);
                
            } catch (error) {
                console.error('åŠ è½½å¿ƒå¾—å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºå¿ƒå¾—
        function displayInsights(insights) {
            const insightsList = document.getElementById('insights-list');
            
            if (!insights || insights.length === 0) {
                insightsList.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ’¡</i>
                        <p>è¿˜æ²¡æœ‰å¿ƒå¾—ï¼Œåˆ†äº«ä½ çš„æ·±åº¦æ€è€ƒå§ï¼</p>
                        <p class="markdown-tip">ğŸ’¡ æ”¯æŒ <strong>Markdown</strong> æ ¼å¼ï¼š<code>**ç²—ä½“**</code> <code>*æ–œä½“*</code> <code>\`ä»£ç \`</code> <code>- åˆ—è¡¨</code> ç­‰</p>
                    </div>
                `;
                return;
            }
            
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-item" data-insight-id="${insight.id}">
                    <div class="insight-header">
                        <div class="insight-header-left">
                            <span class="insight-title">${insight.title}</span>
                            <span class="insight-rating">${'â­'.repeat(insight.rating)}</span>
                        </div>
                        <div class="insight-actions">
                            <button class="btn-action btn-edit" onclick="editInsight('${insight.id}', \`${escapeForJS(insight.title)}\`, ${insight.rating}, \`${escapeForJS(insight.content)}\`, \`${escapeForJS(insight.key_takeaways ? insight.key_takeaways[0] || '' : '')}\`)" title="ç¼–è¾‘">âœï¸</button>
                            <button class="btn-action btn-delete" onclick="deleteInsight('${insight.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="insight-content markdown-content">${renderMarkdown(insight.content)}</div>
                    ${insight.key_takeaways && insight.key_takeaways[0] ? `<div class="insight-takeaway markdown-content">å…³é”®æ”¶è·: ${renderMarkdown(insight.key_takeaways[0])}</div>` : ''}
                </div>
            `).join('');
        }
        
        // æ·»åŠ ç¬”è®°è¡¨å•æäº¤
        document.getElementById('add-note-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const noteData = {
                chapter: document.getElementById('note-chapter').value,
                page: parseInt(document.getElementById('note-page').value) || 0,
                content: document.getElementById('note-content').value
            };
            
            if (!noteData.content.trim()) {
                alert('è¯·è¾“å…¥ç¬”è®°å†…å®¹');
                return;
            }
            
            try {
                const response = await fetch(`/api/books/notes?book_id=${bookId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(noteData)
                });
                
                if (!response.ok) {
                    throw new Error('æ·»åŠ ç¬”è®°å¤±è´¥');
                }
                
                // æ¸…ç©ºè¡¨å•
                this.reset();
                
                // é‡æ–°åŠ è½½ç¬”è®°
                loadNotes();
                
                showToast('ç¬”è®°æ·»åŠ æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('æ·»åŠ ç¬”è®°å¤±è´¥:', error);
                showToast('æ·»åŠ ç¬”è®°å¤±è´¥: ' + error.message, 'error');
            }
        });
        
        // æ·»åŠ å¿ƒå¾—è¡¨å•æäº¤
        document.getElementById('add-insight-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const insightData = {
                title: document.getElementById('insight-title').value,
                rating: parseInt(document.getElementById('insight-rating').value),
                type: document.getElementById('insight-type').value,
                content: document.getElementById('insight-content').value,
                takeaway: document.getElementById('insight-takeaway').value
            };
            
            if (!insightData.title.trim() || !insightData.content.trim()) {
                alert('è¯·è¾“å…¥æ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            try {
                const response = await fetch(`/api/books/insights?book_id=${bookId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(insightData)
                });
                
                if (!response.ok) {
                    throw new Error('æ·»åŠ å¿ƒå¾—å¤±è´¥');
                }
                
                // æ¸…ç©ºè¡¨å•
                this.reset();
                
                // é‡æ–°åŠ è½½å¿ƒå¾—
                loadInsights();
                
                showToast('å¿ƒå¾—æ·»åŠ æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('æ·»åŠ å¿ƒå¾—å¤±è´¥:', error);
                showToast('æ·»åŠ å¿ƒå¾—å¤±è´¥: ' + error.message, 'error');
            }
        });
        
        // ç¬”è®°ç¼–è¾‘å’Œåˆ é™¤åŠŸèƒ½
        
        // ç¼–è¾‘ç¬”è®°
        function editNote(noteId, chapter, page, content) {
            // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
            showEditNoteModal(noteId, chapter, page, content);
        }
        
        // åˆ é™¤ç¬”è®°
        async function deleteNote(noteId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                showToast('æ­£åœ¨åˆ é™¤ç¬”è®°...', 'info');
                
                const response = await fetch(`/api/books/notes?book_id=${bookId}&note_id=${noteId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('åˆ é™¤ç¬”è®°å¤±è´¥');
                }
                
                showToast('ç¬”è®°åˆ é™¤æˆåŠŸï¼', 'success');
                
                // é‡æ–°åŠ è½½ç¬”è®°
                loadNotes();
                
            } catch (error) {
                console.error('åˆ é™¤ç¬”è®°å¤±è´¥:', error);
                showToast('åˆ é™¤ç¬”è®°å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // å¿ƒå¾—ç¼–è¾‘å’Œåˆ é™¤åŠŸèƒ½
        
        // ç¼–è¾‘å¿ƒå¾—
        function editInsight(insightId, title, rating, content, takeaway) {
            // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
            showEditInsightModal(insightId, title, rating, content, takeaway);
        }
        
        // åˆ é™¤å¿ƒå¾—
        async function deleteInsight(insightId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¿ƒå¾—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                showToast('æ­£åœ¨åˆ é™¤å¿ƒå¾—...', 'info');
                
                const response = await fetch(`/api/books/insights?book_id=${bookId}&insight_id=${insightId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('åˆ é™¤å¿ƒå¾—å¤±è´¥');
                }
                
                showToast('å¿ƒå¾—åˆ é™¤æˆåŠŸï¼', 'success');
                
                // é‡æ–°åŠ è½½å¿ƒå¾—
                loadInsights();
                
            } catch (error) {
                console.error('åˆ é™¤å¿ƒå¾—å¤±è´¥:', error);
                showToast('åˆ é™¤å¿ƒå¾—å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºç¼–è¾‘ç¬”è®°æ¨¡æ€æ¡†
        function showEditNoteModal(noteId, chapter, page, content) {
            // è¿™é‡Œå¯ä»¥å¤ç”¨æ·»åŠ ç¬”è®°çš„è¡¨å•ï¼Œæˆ–åˆ›å»ºæ–°çš„ç¼–è¾‘è¡¨å•
            // æš‚æ—¶ä½¿ç”¨ç®€å•çš„promptå®ç°
            const newChapter = prompt('ç¼–è¾‘ç« èŠ‚:', chapter || '');
            if (newChapter === null) return;
            
            const newPageStr = prompt('ç¼–è¾‘é¡µç :', page || '');
            if (newPageStr === null) return;
            const newPage = parseInt(newPageStr) || 0;
            
            const newContent = prompt('ç¼–è¾‘ç¬”è®°å†…å®¹:', content || '');
            if (newContent === null) return;
            
            updateNote(noteId, newChapter, newPage, newContent);
        }
        
        // æ˜¾ç¤ºç¼–è¾‘å¿ƒå¾—æ¨¡æ€æ¡†
        function showEditInsightModal(insightId, title, rating, content, takeaway) {
            // æš‚æ—¶ä½¿ç”¨ç®€å•çš„promptå®ç°
            const newTitle = prompt('ç¼–è¾‘å¿ƒå¾—æ ‡é¢˜:', title || '');
            if (newTitle === null) return;
            
            const newRatingStr = prompt('ç¼–è¾‘è¯„åˆ† (1-5):', rating || '');
            if (newRatingStr === null) return;
            const newRating = parseInt(newRatingStr) || 1;
            if (newRating < 1 || newRating > 5) {
                alert('è¯„åˆ†å¿…é¡»åœ¨1-5ä¹‹é—´');
                return;
            }
            
            const newContent = prompt('ç¼–è¾‘å¿ƒå¾—å†…å®¹:', content || '');
            if (newContent === null) return;
            
            const newTakeaway = prompt('ç¼–è¾‘å…³é”®æ”¶è·:', takeaway || '');
            if (newTakeaway === null) return;
            
            updateInsight(insightId, newTitle, newRating, newContent, newTakeaway);
        }
        
        // æ›´æ–°ç¬”è®°
        async function updateNote(noteId, chapter, page, content) {
            try {
                showToast('æ­£åœ¨æ›´æ–°ç¬”è®°...', 'info');
                
                const response = await fetch(`/api/books/notes?book_id=${bookId}&note_id=${noteId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chapter: chapter,
                        page: page,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    throw new Error('æ›´æ–°ç¬”è®°å¤±è´¥');
                }
                
                showToast('ç¬”è®°æ›´æ–°æˆåŠŸï¼', 'success');
                
                // é‡æ–°åŠ è½½ç¬”è®°
                loadNotes();
                
            } catch (error) {
                console.error('æ›´æ–°ç¬”è®°å¤±è´¥:', error);
                showToast('æ›´æ–°ç¬”è®°å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°å¿ƒå¾—
        async function updateInsight(insightId, title, rating, content, takeaway) {
            try {
                showToast('æ­£åœ¨æ›´æ–°å¿ƒå¾—...', 'info');
                
                const response = await fetch(`/api/books/insights?book_id=${bookId}&insight_id=${insightId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        rating: rating,
                        content: content,
                        takeaway: takeaway
                    })
                });
                
                if (!response.ok) {
                    throw new Error('æ›´æ–°å¿ƒå¾—å¤±è´¥');
                }
                
                showToast('å¿ƒå¾—æ›´æ–°æˆåŠŸï¼', 'success');
                
                // é‡æ–°åŠ è½½å¿ƒå¾—
                loadInsights();
                
            } catch (error) {
                console.error('æ›´æ–°å¿ƒå¾—å¤±è´¥:', error);
                showToast('æ›´æ–°å¿ƒå¾—å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºToasté€šçŸ¥
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            if (type === 'success') {
                toast.style.background = '#6b9080';
            } else if (type === 'error') {
                toast.style.background = '#e63946';
            } else {
                toast.style.background = '#e76f51';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
        
        // Markdownæ¸²æŸ“å‡½æ•°
        function renderMarkdown(text) {
            if (!text) return '';
            
            try {
                // æ£€æŸ¥markedåº“æ˜¯å¦å¯ç”¨
                if (typeof marked === 'undefined') {
                    console.warn('Markedåº“æœªåŠ è½½ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º');
                    return escapeHtml(text).replace(/\n/g, '<br>');
                }
                
                // é…ç½®markedé€‰é¡¹
                marked.setOptions({
                    breaks: true,        // æ”¯æŒæ¢è¡Œ
                    gfm: true,          // æ”¯æŒGitHubé£æ ¼çš„markdown
                    sanitize: false,    // ä¸è¿‡æ»¤HTMLï¼ˆæ³¨æ„å®‰å…¨æ€§ï¼‰
                    smartypants: true   // æ™ºèƒ½æ ‡ç‚¹ç¬¦å·
                });
                
                // æ¸²æŸ“markdown
                return marked.parse(text);
                
            } catch (error) {
                console.error('Markdownæ¸²æŸ“å¤±è´¥:', error);
                // é™çº§åˆ°çº¯æ–‡æœ¬æ˜¾ç¤º
                return escapeHtml(text).replace(/\n/g, '<br>');
            }
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // JavaScriptå­—ç¬¦ä¸²è½¬ä¹‰å‡½æ•°
        function escapeForJS(text) {
            if (!text) return '';
            return text.replace(/\\/g, '\\\\')
                      .replace(/`/g, '\\`')
                      .replace(/\$/g, '\\$')
                      .replace(/'/g, "\\'")
                      .replace(/"/g, '\\"')
                      .replace(/\n/g, '\\n')
                      .replace(/\r/g, '\\r');
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯æ•è·:', event.error);
            return true; // é˜»æ­¢é”™è¯¯è¿›ä¸€æ­¥ä¼ æ’­
        });
        
        // å…¨å±€æœªå¤„ç†çš„Promiseé”™è¯¯
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
            event.preventDefault(); // é˜»æ­¢é”™è¯¯è¿›ä¸€æ­¥ä¼ æ’­
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä»é¡µé¢æ•°æ®ä¸­è·å–ä¹¦ç±ä¿¡æ¯
            const bookData = document.getElementById('book-data');
            const currentPage = parseInt(bookData.getAttribute('data-current-page')) || 0;
            const bookRating = parseFloat(bookData.getAttribute('data-book-rating')) || 0;
            
            // åˆå§‹åŒ–è¿›åº¦æ¡å’Œç™¾åˆ†æ¯”æ˜¾ç¤º
            const progress = pageToPercent(currentPage);
            
            // è®¾ç½®è¿›åº¦æ¡
            document.getElementById('progress-fill').style.width = progress + '%';
            
            // è®¾ç½®è¿›åº¦æ–‡æœ¬
            document.getElementById('progress-text').textContent = progress.toFixed(1) + '%';
            
            // è®¾ç½®è¾“å…¥æ¡†çš„åˆå§‹å€¼
            document.getElementById('current-progress').value = progress.toFixed(1);
            
            // åˆå§‹åŒ–è¯„åˆ†æ˜¾ç¤º
            if (bookRating > 0) {
                const stars = 'â­'.repeat(Math.round(bookRating));
                const ratingElement = document.getElementById('book-rating');
                ratingElement.innerHTML = bookRating.toFixed(1) + ' ' + stars;
            }
            
            // é»˜è®¤åŠ è½½ç¬”è®°
            loadNotes();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç¼–è¾‘å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('edit') === 'true') {
                showEditModal();
            }
        });
    </script>
</body>
</html> 