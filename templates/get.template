<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUCCANG/GET</title>
    <link rel="stylesheet" href="/css/get.css">
</head>
<body id="body" class="th_black">
    <!-- Sidebar -->
	<div id="sidebar-container" class="sidebar-container">
		<div id="sidebar" class="sidebar">
            <a href="/main">
                <div class="img-cycle">G</div>
            </a>
            <a href="/main" style="font-size: 24px;">ä¸»é¡µ</a>
			<div class="separator"></div>
            <h2 id="title">{{.TITLE}}</h2>
			<div class="separator"></div>
            <p id="ctime">{{.CTIME}}</p>
			<div class="separator"></div>
            <label for="tags">æ ‡ç­¾</label>
			<input id="tags" type="text" name="tags" value="{{.TAGS}}">
			<div class="separator"></div>
			
			<label>ğŸ“‹ åšå®¢æƒé™è®¾ç½®
				<button type="button" onclick="PermissionManager.showHelp()" style="margin-left: 5px; font-size: 12px; padding: 2px 6px; background: #444; color: #fff; border: 1px solid #666; border-radius: 3px; cursor: pointer;">?</button>
			</label>
			
			<!-- åŸºç¡€æƒé™ç±»å‹ -->
			<div class="permission-section">
				<label class="section-title">åŸºç¡€æƒé™</label>
				<label class="custom-radio">
					<input class="radio-left" type="radio" name="base_auth_type" value="private" 
						{{ if .IS_PRIVATE }}checked{{ end }}>
					<span class="radio-btn"><i class="checkmark"></i></span>
					<span class="radio-label">ğŸ”’ ç§æœ‰</span>
				</label>
				<label class="custom-radio">
					<input class="radio-left" type="radio" name="base_auth_type" value="public"
						{{ if .IS_PUBLIC }}checked{{ end }}>
					<span class="radio-btn"><i class="checkmark"></i></span>
					<span class="radio-label">ğŸŒ å…¬å¼€</span>
				</label>
			</div>

			<!-- ç‰¹æ®Šæƒé™é€‰é¡¹ -->
			<div class="permission-section">
				<label class="section-title">ç‰¹æ®Šæƒé™</label>
				
				<label class="custom-checkbox">
					<input type="checkbox" name="diary_permission" id="diary_permission"
						{{ if .IS_DIARY }}checked{{ end }}>
					<span class="checkbox-btn"><i class="checkmark"></i></span>
					<span class="checkbox-label">ğŸ“” æ—¥è®°æƒé™</span>
				</label>
				<small class="permission-hint">éœ€è¦é¢å¤–å¯†ç éªŒè¯</small>
				
				<label class="custom-checkbox">
					<input type="checkbox" name="cooperation_permission" id="cooperation_permission"
						{{ if .IS_COOPERATION }}checked{{ end }}>
					<span class="checkbox-btn"><i class="checkmark"></i></span>
					<span class="checkbox-label">ğŸ¤ åä½œæƒé™</span>
				</label>
				<small class="permission-hint">å…è®¸åä½œç”¨æˆ·è®¿é—®</small>
				
				<label class="custom-checkbox">
					<input type="checkbox" name="encrypt_permission" id="encrypt_permission"
						{{ if .IS_ENCRYPTED }}checked{{ end }}>
					<span class="checkbox-btn"><i class="checkmark"></i></span>
					<span class="checkbox-label">ğŸ” å†…å®¹åŠ å¯†</span>
				</label>
				<small class="permission-hint">ä½¿ç”¨AESåŠ å¯†ä¿æŠ¤å†…å®¹</small>
			</div>
			
			<div class="separator"></div>
			<div style="margin-top: auto;" id="encrypt-section-edit">
				<label for="encrypt-password" id="encrypt-password-label">ğŸ” åŠ å¯†å¯†ç </label>
				<input id="encrypt-password" type="password" name="encrypt-password" placeholder="è®¾ç½®åŠ å¯†å¯†ç ..." 
					value="">
				<small class="encrypt-hint" id="encrypt-password-hint">ğŸ’¡ å¯ç”¨"å†…å®¹åŠ å¯†"æƒé™æ—¶å¿…é¡»è®¾ç½®å¯†ç </small>

			</div>
			<div class="separator"></div>
            <button id="delete-button" class="bottom-button" onclick="onDelete()">åˆ é™¤</button>
		</div>
        <div class="bubble" id="bubble">&#9776;</div>
	</div>

    <!-- Main Content -->
	<div class="container">
		<div class="buttons-container">
		<button id="toggle-button" class="right-button" type="button" onclick="onEditor()">ç¼–è¾‘</button>
		</div>
        
		<div class="editor-container">
			<textarea id="editor-inner" class="hide th_black" name="content" wrap="hard">{{.CONTENT}}</textarea>
			<div id="md" class="md"></div>
		</div>
        
		<div class="bottom-container">
		{{ if or (eq "aes" .ENCRYPT) .IS_ENCRYPTED }}
			<div class="decrypt-container">
				<label for="decrypt-password" style="display: block; margin-bottom: 5px; font-size: 14px; color: #e0e0e0;">ğŸ”“ è§£å¯†å¯†ç </label>
				<input id="decrypt-password" type="password" name="decrypt-password" placeholder="è¾“å…¥è§£å¯†å¯†ç æŸ¥çœ‹å†…å®¹">
				<button id="decrypt-button" class="decrypt-btn" type="button" onclick="onDecrypt()">ğŸ”“ è§£å¯†å†…å®¹</button>
				<small style="display: block; margin-top: 5px; font-size: 11px; color: #888;">è¾“å…¥æ­£ç¡®çš„è§£å¯†å¯†ç æ¥æŸ¥çœ‹åšå®¢å†…å®¹</small>
			</div>
		{{end}}
			<button id="editor-button" class="bottom-button" onclick="submitFirst()">ä¿å­˜ä¿®æ”¹</button>
		</div>

		<div class="comments-section">
			<div class="comments-header">
				<h3 class="comments-title">ğŸ’¬ è¯„è®ºåŒº</h3>
				<button id="comment-show" class="comments-toggle-btn expanded" onclick="onShowComment()">
					<span id="toggle-text">æ”¶èµ·è¯„è®º</span>
					<span id="toggle-icon">â–²</span>
				</button>
			</div>
			
			<div id="comments-container">
				<style>
					/* ç¡®ä¿è¯„è®ºè¡¨å•è¾“å…¥æ¡†å¯è§å’Œå¯äº¤äº’ */
					.comment-form input,
					.comment-form textarea {
						pointer-events: auto !important;
						user-select: text !important;
						-webkit-user-select: text !important;
						-moz-user-select: text !important;
					}
				</style>
				<!-- è¯„è®ºåˆ—è¡¨ -->
				<div id="comments" class="comments-list">
					{{if .COMMENTS}}
						{{range .COMMENTS}}
						<div class="comment-card">
							<div class="comment-header">
								<div class="comment-author">
									<div class="author-avatar">{{slice .OWNER 0 1}}</div>
									<div class="author-info">
										<div class="author-name">{{.OWNER}}</div>
										{{if .MAIL}}<div class="author-email">{{.MAIL}}</div>{{end}}
									</div>
								</div>
								<div class="comment-meta">
									<span class="comment-time">{{.CTIME}}</span>
									<span class="comment-index">#{{.IDX}}</span>
								</div>
							</div>
							<div class="comment-content">
								<p>{{.MSG}}</p>
							</div>
						</div>
						{{end}}
					{{else}}
						<div class="no-comments">
							<div class="no-comments-icon">ğŸ’­</div>
							<p>è¿˜æ²¡æœ‰è¯„è®ºï¼Œæ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
						</div>
					{{end}}
				</div>

				<!-- å‘è¡¨è¯„è®º -->
				<div id="div-comment" class="comment-form-container">
					<h4 class="comment-form-title">âœï¸ å‘è¡¨è¯„è®º</h4>
					<form class="comment-form" onsubmit="return false;">
						<div class="form-row">
							<div class="form-group">
								<label for="input-owner">ç”¨æˆ·å *</label>
								<input id="input-owner" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å" required>
								<small id="username-hint" class="form-hint">ğŸ’¡ ç”¨æˆ·åå°†ä½œä¸ºæ‚¨çš„èº«ä»½æ ‡è¯†</small>
							</div>
							<div class="form-group">
								<label for="input-mail">é‚®ç®±</label>
								<input id="input-mail" type="email" placeholder="è¯·è¾“å…¥é‚®ç®±ï¼ˆå¯é€‰ï¼‰">
							</div>
						</div>
						<div class="form-group">
							<label for="input-pwd">èº«ä»½å¯†ç </label>
							<input id="input-pwd" type="password" placeholder="ç”¨äºç¡®è®¤æ‚¨çš„èº«ä»½">
							<small class="form-hint">ğŸ’¡ å·²æ³¨å†Œç”¨æˆ·åå¿…é¡»è¾“å…¥æ­£ç¡®å¯†ç æ‰èƒ½è¯„è®º</small>
						</div>
						<div class="form-group">
							<label for="input-comment">è¯„è®ºå†…å®¹ *</label>
							<textarea id="input-comment" rows="4" placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„è®ºå†…å®¹..." required></textarea>
							<div class="comment-input-footer">
								<small class="form-hint">æ”¯æŒæ¢è¡Œï¼Œè¯·æ–‡æ˜å‘è¨€</small>
								<span class="char-count"><span id="char-counter">0</span>/500</span>
							</div>
						</div>
						<div class="form-actions">
							<button id="commit-comment" type="button" onclick="onCommitComment()" class="submit-btn">
								<span class="btn-icon">ğŸ“</span>
								<span class="btn-text">å‘è¡¨è¯„è®º</span>
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
	<script src="/js/vim/vim.min.js"></script>
	<script src="/js/marked/marked.min.js"></script>
	<script src="/js/editor.js"></script>
	<script src="/js/utils.js"></script>
	<script src="/js/permissions.js"></script>
	<script src="/js/get.js"></script>
	
	<!-- å…³é”®å­—é«˜äº®è„šæœ¬ -->
	<script>
		function highlightKeywords() {
			// ä»URLå‚æ•°ä¸­è·å–highlightå…³é”®å­—
			const urlParams = new URLSearchParams(window.location.search);
			const highlight = urlParams.get('highlight');
			
			if (!highlight) return;
			
			// å¯¹å…³é”®å­—è¿›è¡ŒURLè§£ç 
			const keyword = decodeURIComponent(highlight);
			
			// è·å–è¦é«˜äº®çš„å†…å®¹åŒºåŸŸ
			const contentArea = document.getElementById('md');
			if (!contentArea) return;
			
			// å­˜å‚¨åŒ…å«å…³é”®å­—çš„è¡Œå…ƒç´ 
			const highlightedLines = new Set();
			
			// é«˜äº®å‡½æ•°
			function highlightText(element, keyword) {
				if (element.nodeType === Node.TEXT_NODE) {
					const text = element.textContent;
					const regex = new RegExp('(' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
					
					if (regex.test(text)) {
						const highlightedText = text.replace(regex, '<span class="highlight-keyword">$1</span>');
						const wrapper = document.createElement('div');
						wrapper.innerHTML = highlightedText;
						
						// æ›¿æ¢åŸæ–‡æœ¬èŠ‚ç‚¹
						const parent = element.parentNode;
						while (wrapper.firstChild) {
							parent.insertBefore(wrapper.firstChild, element);
						}
						parent.removeChild(element);
						
						// æ‰¾åˆ°åŒ…å«æ­¤å…³é”®å­—çš„è¡Œçº§å…ƒç´ å¹¶æ ‡è®°
						markContainingLine(parent);
					}
				} else if (element.nodeType === Node.ELEMENT_NODE) {
					// é¿å…åœ¨å·²ç»é«˜äº®çš„å…ƒç´ å’ŒæŸäº›æ ‡ç­¾ä¸­è¿›è¡Œé«˜äº®
					if (element.className && element.className.includes('highlight-keyword')) return;
					if (['SCRIPT', 'STYLE', 'CODE', 'PRE'].includes(element.tagName)) return;
					
					const children = Array.from(element.childNodes);
					children.forEach(child => highlightText(child, keyword));
				}
			}
			
			// æ ‡è®°åŒ…å«å…³é”®å­—çš„è¡Œ
			function markContainingLine(element) {
				let currentElement = element;
				
				// å‘ä¸ŠæŸ¥æ‰¾å¯èƒ½çš„è¡Œçº§å…ƒç´ 
				while (currentElement && currentElement !== contentArea) {
					const tagName = currentElement.tagName;
					
					// æ£€æŸ¥æ˜¯å¦æ˜¯è¡Œçº§å…ƒç´ 
					if (tagName && (
						tagName === 'P' || 
						tagName === 'DIV' || 
						tagName === 'H1' || tagName === 'H2' || tagName === 'H3' || 
						tagName === 'H4' || tagName === 'H5' || tagName === 'H6' ||
						tagName === 'LI' ||
						tagName === 'BLOCKQUOTE' ||
						tagName === 'TD' || tagName === 'TH'
					)) {
						if (!highlightedLines.has(currentElement)) {
							currentElement.classList.add('highlight-line');
							highlightedLines.add(currentElement);
						}
						break;
					}
					
					currentElement = currentElement.parentNode;
				}
				
				// å¦‚æœæ²¡æ‰¾åˆ°åˆé€‚çš„è¡Œçº§å…ƒç´ ï¼Œå°è¯•åŒ…è£…å½“å‰å…ƒç´ 
				if (!currentElement || currentElement === contentArea) {
					let lineElement = element;
					while (lineElement && lineElement.parentNode !== contentArea) {
						lineElement = lineElement.parentNode;
					}
					if (lineElement && !highlightedLines.has(lineElement)) {
						lineElement.classList.add('highlight-line');
						highlightedLines.add(lineElement);
					}
				}
			}
			
			// æ‰§è¡Œé«˜äº®
			highlightText(contentArea, keyword);
		}
		
		// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œé«˜äº®
		document.addEventListener('DOMContentLoaded', function() {
			// ç­‰å¾…markdownæ¸²æŸ“å®Œæˆåå†é«˜äº®
			setTimeout(highlightKeywords, 100);
		});
		
		// ç›‘å¬markdownå†…å®¹æ›´æ–°ï¼ˆå¦‚æœæœ‰åŠ¨æ€æ›´æ–°çš„è¯ï¼‰
		const observer = new MutationObserver(function(mutations) {
			mutations.forEach(function(mutation) {
				if (mutation.type === 'childList' && mutation.target.id === 'md') {
					setTimeout(highlightKeywords, 50);
				}
			});
		});
		
		const mdElement = document.getElementById('md');
		if (mdElement) {
			observer.observe(mdElement, { childList: true, subtree: true });
		}
	</script>
</body>
</html>
