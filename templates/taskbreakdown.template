<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务拆解追踪 - GUCCANG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/taskbreakdown.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
</head>
<body data-root-task-id="{{.RootTaskID}}">
    <header class="page-header">
        <div class="container">
            <a href="/main">
                <div class="img-cycle">G</div>
            </a>
            <h1 class="page-title">任务拆解追踪</h1>
            <a href="/editor" class="header-link">创建博客</a>
            <a href="/taskbreakdown/completed" class="header-link">查看已完成任务</a>
            <a href="/taskbreakdown/deleted" class="header-link">查看已删除任务</a>
            <div class="header-controls">
                <button id="refreshBtn" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> 刷新</button>
                <button id="syncToTodoBtn" class="btn btn-primary"><i class="fas fa-tasks"></i> 同步到今日待办</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- 根任务面包屑导航 -->
        <div id="rootTaskBreadcrumb" class="breadcrumb" style="display: none;">
            <a href="/taskbreakdown" class="breadcrumb-link">所有任务</a>
            <span class="breadcrumb-separator">/</span>
            <span id="rootTaskTitle" class="breadcrumb-current">根任务</span>
        </div>

        <!-- 统计面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">总任务数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedTasks">0</div>
                <div class="stat-label">已完成</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="inProgressTasks">0</div>
                <div class="stat-label">进行中</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="blockedTasks">0</div>
                <div class="stat-label">阻塞中</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTime">0h</div>
                <div class="stat-label">总预估时间</div>
            <div class="stat-card warning" id="timeWarningCard" style="display: none;">
                <div class="stat-value"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-label" id="timeWarningLabel">时间冲突警告</div>
            </div>
        </div>

        <!-- 时间配置面板 (仅在AllTasks视图显示) -->
        <div class="config-panel" id="configPanel" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cog"></i> 每日时间配置</h3>
                </div>
                <div class="card-body">
                    <div class="config-content">
                        <div class="config-item">
                            <label for="dailyAvailableTime">每天可用时间 (分钟):</label>
                            <input type="number" id="dailyAvailableTime" class="form-control" value="480" min="0" step="30">
                            <div class="field-help">设置每天可用于任务的总时间，用于检测时间冲突</div>
                        </div>
                        <div class="config-actions">
                            <button id="saveConfig" class="btn btn-primary"><i class="fas fa-save"></i> 保存配置</button>
                        </div>
                        <div class="config-info" id="timeUsageInfo" style="display: none;">
                            <div class="info-item">
                                <span class="info-label">当前总分配时间</span>
                                <span class="info-value" id="totalDailyTime">0 分钟</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">可用时间:</span>
                                <span class="info-value" id="availableTime">480 分钟</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">剩余时间:</span>
                                <span class="info-value" id="remainingTime">480 分钟</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- 根任务列表-->
        <div class="root-tasks-panel" id="rootTasksPanel" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">根任务列表</h3>
                </div>
                <div class="card-body">
                    <div id="rootTasksList" class="root-tasks-list">
                        <!-- 根任务将通过JavaScript动态生成-->
                    </div>
                </div>
            </div>
        </div>

        <!-- 选项卡导航-->
        <div class="tabs-navigation">
            <div class="tabs">
                <button class="tab-link active" data-tab="taskTab">任务树</button>
                <button class="tab-link" data-tab="timelineTab">时间线</button>
                <button class="tab-link" data-tab="statsTab">统计图表</button>
                <button class="tab-link" data-tab="trendsTab">时间趋势</button>
            </div>
        </div>

        <!-- 选项卡内容区域-->
        <div class="tab-content">
            <!-- 任务树选项卡-->
            <div id="taskTab" class="tab-pane active">
                <div class="main-content">
                    <!-- 左侧：任务树 -->
                    <div class="task-tree-container" id="taskTreeView">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">任务树</h2>
                                <div class="task-filter-controls">
                                    <select id="statusFilter" class="form-control">
                                        <option value="">全部状态</option>
                                        <option value="completed">已完成</option>
                                        <option value="planning,in-progress,blocked">未完成</option>
                                        <option value="planning">规划中</option>
                                        <option value="in-progress">进行中</option>
                                        <option value="blocked">阻塞中</option>
                                        <option value="cancelled">已取消</option>
                                    </select>
                                    <button id="toggleGrouping" class="btn btn-secondary" title="切换根任务分组显示">
                                        <i class="fas fa-layer-group"></i> 分组
                                    </button>
                                </div>
                                <button id="addRootTask" class="btn btn-primary"><i class="fas fa-plus"></i> 添加根任务</button>
                            </div>
                            <div class="card-body">
                                <div id="taskTree" class="task-tree">
                                    <!-- 任务树将通过JavaScript动态生成-->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：任务详情和时间线-->
                    <div class="task-details-container">
                        <!-- 任务详情面板 -->
                        <div class="card task-details-card" id="taskDetailsCard" style="display: none;">
                            <div class="card-header">
                                <h2 class="card-title">任务详情</h2>
                                <div class="task-actions">
                                    <button id="editTask" class="btn btn-secondary"><i class="fas fa-edit"></i> 编辑</button>
                                    <button id="deleteTask" class="btn btn-danger"><i class="fas fa-trash"></i> 删除</button>
                                    <button id="addSubtask" class="btn btn-primary"><i class="fas fa-plus"></i> 添加子任务</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="task-detail-content">
                                    <h3 id="taskTitle">任务标题</h3>
                                    <div class="task-meta">
                                        <span class="task-status" id="taskStatus">规划中</span>
                                        <span class="task-priority" id="taskPriority">中等</span>
                                        <span class="task-progress" id="taskProgress">0%</span>
                                    </div>
                                    <div class="task-description" id="taskDescription">任务描述...</div>
                                    <div class="task-blog-link" id="taskBlogLink" style="margin-top: 10px; margin-bottom: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">
                                        <strong>博客链接:</strong> <a id="taskBlogLinkAnchor" href="#" target="_blank">[任务博客]</a>
                                    </div>
                                    <div class="task-dates">
                                        <div><strong>开始日期</strong> <span id="taskStartDate">-</span></div>
                                        <div><strong>结束日期:</strong> <span id="taskEndDate">-</span></div>
                                        <div><strong>预计时间:</strong> <span id="taskEstimatedTime">0分钟</span></div>
                                        <div><strong>每天分配时间:</strong> <span id="taskDailyTime">0分钟</span></div>
                                        <div><strong>实际时间:</strong> <span id="taskActualTime">0分钟</span></div>
                                        <div><strong>创建时间:</strong> <span id="taskCreatedAt">-</span></div>
                                        <div><strong>更新时间:</strong> <span id="taskUpdatedAt">-</span></div>
                                    </div>
                                    <div class="task-tags" id="taskTags">
                                        <!-- 标签将通过JavaScript动态生成-->
                                    </div>

                                    <!-- 时间分析面板 -->
                                    <div class="time-analysis-panel" id="timeAnalysisPanel" style="display: none;">
                                        <h4><i class="fas fa-clock"></i> 时间分析</h4>
                                        <div class="time-analysis-content">
                                            <div class="time-analysis-section">
                                                <h5>父子任务时间对比</h5>
                                                <div class="time-comparison">
                                                    <div class="time-item">
                                                        <span class="time-label">自身预计时间:</span>
                                                        <span class="time-value" id="selfEstimatedTime">0分钟</span>
                                                    </div>
                                                    <div class="time-item">
                                                        <span class="time-label">子任务预计时间总和:</span>
                                                        <span class="time-value" id="subtasksEstimatedTime">0分钟</span>
                                                        <span class="time-diff" id="estimatedTimeDiff">(差异: 0分钟)</span>
                                                    </div>
                                                    <div class="time-status" id="estimatedTimeStatus">
                                                        <i class="fas fa-check-circle"></i> 时间充足
                                                    </div>
                                                </div>
                                                <div class="time-comparison">
                                                    <div class="time-item">
                                                        <span class="time-label">自身每天分配时间:</span>
                                                        <span class="time-value" id="selfDailyTime">0分钟</span>
                                                    </div>
                                                    <div class="time-item">
                                                        <span class="time-label">子任务每天分配时间总和:</span>
                                                        <span class="time-value" id="subtasksDailyTime">0分钟</span>
                                                        <span class="time-diff" id="dailyTimeDiff">(差异: 0分钟)</span>
                                                    </div>
                                                    <div class="time-status" id="dailyTimeStatus">
                                                        <i class="fas fa-check-circle"></i> 时间分配合理
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="time-analysis-section">
                                                <h5>子任务时间详情</h5>
                                                <div id="subtaskTimeDetails">
                                                    <p><i class="fas fa-spinner fa-spin"></i> 加载子任务时间详情...</p>
                                                </div>
                                            </div>
                                            <div class="time-analysis-section">
                                                <h5>子任务时间重叠检测</h5>
                                                <div id="timeOverlapResult">
                                                    <p><i class="fas fa-spinner fa-spin"></i> 检测中...</p>
                                                </div>
                                            </div>
                                            <div class="time-analysis-section">
                                                <h5>时间字段说明</h5>
                                                <div class="time-explanation">
                                                    <p><strong>预计时间</strong>: 完成该任务预计需要的时间（分钟）</p>
                                                    <p><strong>每天分配时间</strong>: 计划每天为该任务分配的时间（分钟）</p>
                                                    <p><strong>实际时间</strong>: 实际花费的时间（分钟），用于跟踪进度</p>
                                                    <p class="time-tip"><i class="fas fa-lightbulb"></i> 提示: 子任务时间总和不应超过父任务的时间分配</p>
                                                </div>
                                            </div>
                                            <div class="time-analysis-section">
                                                <h5>时间对比与评价</h5>
                                                <div class="time-evaluation" id="timeEvaluation">
                                                    <div class="evaluation-item">
                                                        <span class="evaluation-label">预计时间:</span>
                                                        <span class="evaluation-value" id="evalEstimatedTime">0分钟</span>
                                                    </div>
                                                    <div class="evaluation-item">
                                                        <span class="evaluation-label">实际时间:</span>
                                                        <span class="evaluation-value" id="evalActualTime">0分钟</span>
                                                    </div>
                                                    <div class="evaluation-item">
                                                        <span class="evaluation-label">时间偏差:</span>
                                                        <span class="evaluation-value" id="evalTimeDiff">0分钟</span>
                                                        <span class="evaluation-percent" id="evalTimePercent">0%</span>
                                                    </div>
                                                    <div class="evaluation-result" id="evalResult">
                                                        <i class="fas fa-info-circle"></i> 任务尚未完成
                                                    </div>
                                                    <div class="evaluation-explanation" id="evalExplanation">
                                                        <p><strong>计算过程:</strong></p>
                                                        <ul>
                                                            <li><strong>预计时间</strong> = 每天分配时间 × (结束日期 - 开始日期 天数</li>
                                                            <li><strong>实际时间</strong> = 每天分配时间 × (结束日期 - 开始日期 天数（任务完成时自动计算）</li>
                                                            <li><strong>时间偏差:</strong> = 实际时间 - 预计时间</li>
                                                            <li><strong>偏差百分比</strong> = (时间偏差 ÷ 预计时间) × 100%</li>
                                                        </ul>
                                                        <p><strong>评价标准:</strong></p>
                                                        <ul>
                                                            <li><span class="eval-good"><i class="fas fa-check-circle"></i> 提前完成</span>: 实际时间 < 预计时间（偏差 < -10%）</li>
                                                            <li><span class="eval-ok"><i class="fas fa-check-circle"></i> 按时完成</span>: 实际时间 ≈ 预计时间（偏差在 ±10% 内）</li>
                                                            <li><span class="eval-warning"><i class="fas fa-exclamation-circle"></i> 轻微超时</span>: 实际时间 > 预计时间（偏差在 10%~30%）</li>
                                                            <li><span class="eval-bad"><i class="fas fa-times-circle"></i> 严重超时</span>: 实际时间 >> 预计时间（偏差 > 30%）</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- 时间线选项卡-->
            <div id="timelineTab" class="tab-pane">
                <div class="timeline-tab-content">
                    <div class="card timeline-card" id="timelineView">
                        <div class="card-header">
                            <h2 class="card-title">时间线视图</h2>
                        </div>
                        <div class="card-body">
                            <div id="timelineChart">
                                <!-- 时间线图表将通过JavaScript动态生成-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计图表选项卡-->
            <div id="statsTab" class="tab-pane">
                <div class="stats-tab-content">
                    <div class="card stats-card">
                        <div class="card-header">
                            <h2 class="card-title">统计图表</h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statusChart" width="400" height="200"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="priorityChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 时间趋势选项卡 -->
            <div id="trendsTab" class="tab-pane">
                <div class="trends-tab-content">
                    <div class="card trends-card">
                        <div class="card-header">
                            <h2 class="card-title">时间趋势</h2>
                            <div class="trends-controls">
                                <select id="timeRangeSelect" class="form-control" style="width: auto; display: inline-block;">
                                    <option value="7d">最近7天</option>
                                    <option value="30d" selected>最近30天</option>
                                    <option value="90d">最近90天</option>
                                    <option value="1y">最近1年</option>
                                </select>
                                <button id="refreshTrendsBtn" class="btn btn-secondary btn-small">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="creationTrendChart" width="400" height="200"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="completionTrendChart" width="400" height="200"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="progressTrendChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：添加/编辑任务 -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加新任务</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    <input type="hidden" id="parentId">

                    <div class="form-group">
                        <label for="title">任务标题 *</label>
                        <input type="text" id="title" required>
                    </div>

                    <div class="form-group">
                        <label for="description">任务描述</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">状态</label>
                            <select id="status">
                                <option value="planning">规划中</option>
                                <option value="in-progress">进行中</option>
                                <option value="completed">已完成</option>
                                <option value="blocked">阻塞中</option>
                                <option value="cancelled">已取消</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="priority">优先级</label>
                            <select id="priority">
                                <option value="1">最高</option>
                                <option value="2">高</option>
                                <option value="3" selected>中等</option>
                                <option value="4">低</option>
                                <option value="5">最低</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">开始日期</label>
                            <input type="date" id="startDate">
                        </div>

                        <div class="form-group">
                            <label for="endDate">结束日期</label>
                            <input type="date" id="endDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="estimatedTime">预计时间(分钟)</label>
                            <input type="number" id="estimatedTime" min="0" value="0">
                            <div class="field-help">完成该任务预计需要的时间</div>
                        </div>

                        <div class="form-group">
                            <label for="dailyTime">每天分配时间(分钟)</label>
                            <input type="number" id="dailyTime" min="0" value="0">
                            <div class="field-help">计划每天为该任务分配的时间</div>
                        </div>

                        <div class="form-group">
                            <label for="progress">进度(%)</label>
                            <input type="range" id="progress" min="0" max="100" value="0">
                            <span id="progressValue">0%</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>重复周期</label>
                        <div class="repeat-days-container">
                            <div class="repeat-day-option">
                                <input type="checkbox" id="repeatMon" name="repeatDays" value="mon">
                                <label for="repeatMon">星期一</label>
                            </div>
                            <div class="repeat-day-option">
                                <input type="checkbox" id="repeatTue" name="repeatDays" value="tue">
                                <label for="repeatTue">星期二</label>
                            </div>
                            <div class="repeat-day-option">
                                <input type="checkbox" id="repeatWed" name="repeatDays" value="wed">
                                <label for="repeatWed">星期三</label>
                            </div>
                            <div class="repeat-day-option">
                                <input type="checkbox" id="repeatThu" name="repeatDays" value="thu">
                                <label for="repeatThu">星期四</label>
                            </div>
                            <div class="repeat-day-option">
                                <input type="checkbox" id="repeatFri" name="repeatDays" value="fri">
                                <label for="repeatFri">星期五</label>
                            </div>
                            <div class="repeat-day-option">
                                <input type="checkbox" id="repeatSat" name="repeatDays" value="sat">
                                <label for="repeatSat">星期六</label>
                            </div>
                            <div class="repeat-day-option">
                                <input type="checkbox" id="repeatSun" name="repeatDays" value="sun">
                                <label for="repeatSun">星期日</label>
                            </div>
                        </div>
                        <div class="field-help">选择任务重复的星期几（可多选）</div>
                    </div>

                    <div class="form-group">
                        <label for="tags">标签(用逗号分隔)</label>
                        <input type="text" id="tags" placeholder="例如: 工作,项目,重要">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close">取消</button>
                <button type="button" class="btn btn-primary" id="saveTask">保存</button>
            </div>
        </div>
    </div>

    <script src="/js/taskbreakdown.js"></script>
</body>
</html>
