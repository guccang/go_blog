<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeGen - AI ç¼–ç¨‹åŠ©æ‰‹</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #484f58;
            --accent: #58a6ff;
            --accent-hover: #79c0ff;
            --green: #3fb950;
            --yellow: #d29922;
            --red: #f85149;
            --purple: #bc8cff;
            --orange: #f0883e;
            --cyan: #39d2c0;
            --radius: 8px;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
            --font-sans: 'Inter', -apple-system, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .app {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 56px 1fr;
            height: 100vh;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 16px;
        }
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header .badge {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        .header .workspace-path {
            margin-left: auto;
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-muted);
        }
        .header .btn-home {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            transition: all 0.2s;
        }
        .header .btn-home:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-new {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 4px 12px;
            border-radius: var(--radius);
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-new:hover { background: var(--accent-hover); }

        .project-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .project-item {
            padding: 10px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background 0.15s;
            margin-bottom: 2px;
        }
        .project-item:hover { background: var(--bg-tertiary); }
        .project-item.active {
            background: var(--bg-tertiary);
            border-left: 2px solid var(--accent);
        }
        .project-item .name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .project-item .meta {
            font-size: 11px;
            color: var(--text-muted);
        }
        .project-item .agent-badge {
            display: inline-block;
            background: rgba(188, 140, 255, 0.15);
            color: var(--purple);
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 500;
        }

        /* Agent status */
        .agent-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 12px;
        }
        .agent-status .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .agent-status .dot.online {
            background: var(--green);
        }
        .agent-section-header {
            padding: 8px 12px 4px;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Main */
        .main {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Welcome */
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        .welcome .icon { font-size: 48px; }
        .welcome h2 { font-size: 22px; color: var(--text-primary); }
        .welcome p { color: var(--text-secondary); max-width: 400px; text-align: center; line-height: 1.6; }

        /* Output */
        .output-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
            display: none;
        }
        .output-area.active { display: block; }

        .event-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        .event-item.system {
            color: var(--text-muted);
            font-style: italic;
        }
        .event-item.tool {
            background: rgba(88, 166, 255, 0.08);
            border-left: 3px solid var(--accent);
            font-family: var(--font-mono);
            font-size: 12px;
        }
        .tool-header {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .tool-detail {
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px 0;
            line-height: 1.4;
        }
        .event-item.assistant {
            background: var(--bg-tertiary);
            white-space: pre-wrap;
        }
        .event-item.thinking {
            background: rgba(188, 140, 255, 0.06);
            border-left: 3px solid var(--purple);
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }
        .event-item.thinking .thinking-header {
            color: var(--purple);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .event-item.thinking .thinking-header .toggle-icon {
            font-size: 10px;
            transition: transform 0.2s ease;
        }
        .event-item.thinking:not(.collapsed) .thinking-header .toggle-icon {
            transform: rotate(90deg);
        }
        .event-item.thinking .thinking-content {
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
            margin-top: 6px;
            padding: 6px 8px;
            background: rgba(188, 140, 255, 0.04);
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: var(--font-mono);
            line-height: 1.5;
        }
        .event-item.thinking.collapsed .thinking-content {
            display: none;
        }
        .event-item.result {
            background: rgba(63, 185, 80, 0.1);
            border-left: 3px solid var(--green);
            color: var(--green);
        }
        .event-item.error {
            background: rgba(248, 81, 73, 0.1);
            border-left: 3px solid var(--red);
            color: var(--red);
        }
        .event-item .cost {
            float: right;
            color: var(--yellow);
            font-size: 11px;
        }

        /* Status bar */
        .status-bar {
            padding: 6px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .status-dot.running {
            background: var(--green);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* Input */
        .input-area {
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }
        .input-area input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-sans);
            outline: none;
            transition: border-color 0.2s;
        }
        .input-area input:focus { border-color: var(--accent); }
        .input-area input::placeholder { color: var(--text-muted); }

        .btn-send {
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .btn-send:hover { opacity: 0.9; }
        .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-stop {
            background: var(--red);
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius);
            font-size: 13px;
            cursor: pointer;
            display: none;
        }
        .btn-stop.visible { display: block; }

        .model-select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: var(--font-sans);
            outline: none;
            cursor: pointer;
            min-width: 100px;
            transition: border-color 0.2s;
        }
        .model-select:focus { border-color: var(--accent); }
        .model-select option { background: var(--bg-secondary); color: var(--text-primary); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            width: 400px;
        }
        .modal h3 { margin-bottom: 16px; font-size: 16px; }
        .modal input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            margin-bottom: 16px;
        }
        .modal input:focus { border-color: var(--accent); }
        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .modal-actions button {
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 13px;
            cursor: pointer;
            border: none;
        }
        .modal-actions .btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        .modal-actions .btn-confirm {
            background: var(--accent);
            color: #fff;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <h1>âš¡ CodeGen</h1>
            <span class="badge">Claude Code</span>
            <span class="workspace-path" id="workspacePath"></span>
            <div class="agent-status" id="agentStatus" style="display:none">
                <span class="dot" id="agentDot"></span>
                <span id="agentText"></span>
            </div>
            <a href="/main" class="btn-home">â† è¿”å›</a>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>ğŸ“‚ é¡¹ç›®</h3>
                <button class="btn-new" onclick="showNewProjectModal()">+ æ–°å»º</button>
            </div>
            <div style="padding: 6px 8px; border-bottom: 1px solid var(--border);">
                <input type="text" id="projectSearch" placeholder="æœç´¢é¡¹ç›®..."
                       oninput="filterProjects()"
                       style="width:100%; background:var(--bg-primary); border:1px solid var(--border); border-radius:var(--radius); padding:6px 10px; color:var(--text-primary); font-size:12px; outline:none;">
            </div>
            <div class="project-list" id="projectList">
                <div style="padding: 20px; color: var(--text-muted); text-align: center; font-size: 13px;">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>

        <!-- Main -->
        <div class="main">
            <div class="welcome" id="welcomeView">
                <div class="icon">âš¡</div>
                <h2>AI ç¼–ç¨‹åŠ©æ‰‹</h2>
                <p>é€‰æ‹©å·¦ä¾§ç¼–ç é¡¹ç›®è¾“å…¥éœ€æ±‚ï¼Œæˆ–é€‰æ‹©éƒ¨ç½²é¡¹ç›®ä¸€é”®éƒ¨ç½²ã€‚</p>
            </div>

            <div class="output-area" id="outputArea"></div>

            <div class="status-bar" id="statusBar">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">å°±ç»ª</span>
                <span style="margin-left: auto" id="costText"></span>
            </div>

            <div class="input-area" id="codeInputArea">
                <select id="modelSelect" class="model-select" title="é€‰æ‹©æ¨¡å‹é…ç½®">
                    <option value="">é»˜è®¤</option>
                </select>
                <select id="toolSelect" class="model-select" title="é€‰æ‹©ç¼–ç å·¥å…·" style="min-width:120px;">
                    <option value="">Claude Code</option>
                </select>
                <input type="text" id="promptInput" placeholder="æè¿°ç¼–ç éœ€æ±‚... (å¦‚: åˆ›å»ºä¸€ä¸ª Go HTTP æœåŠ¡)">
                <button class="btn-send" id="btnSend" onclick="sendPrompt()">å‘é€</button>
                <button class="btn-stop" id="btnStop" onclick="stopSession()">â¹ åœæ­¢</button>
            </div>
            <div class="input-area" id="deployInputArea" style="display:none;">
                <button class="btn-send" id="btnDeployRun" onclick="deployProject()" style="background:linear-gradient(135deg, var(--orange), var(--red)); flex:1;">ğŸš€ éƒ¨ç½²é¡¹ç›®</button>
                <button class="btn-stop" id="btnDeployStop" onclick="stopSession()">â¹ åœæ­¢</button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal">
            <h3>ğŸ“ æ–°å»ºé¡¹ç›®</h3>
            <input type="text" id="newProjectName" placeholder="é¡¹ç›®åç§° (å¦‚: my-web-app)">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideNewProjectModal()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="createProject()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
    let currentProject = null;
    let currentSessionId = null;
    let currentMode = 'code'; // 'code' or 'deploy'
    let ws = null;
    let remoteProjectMap = {}; // project name -> agent info
    let cachedLocalProjects = [];
    let cachedRemoteOnly = [];
    let cachedCodingRemote = [];   // è¿œç¨‹é¡¹ç›®ä¸­æ”¯æŒç¼–ç çš„
    let cachedDeployProjects = []; // è¿œç¨‹é¡¹ç›®ä¸­æ”¯æŒéƒ¨ç½²çš„
    let cachedClaudeCodeModels = [];
    let cachedOpenCodeModels = [];

    // æ¯ä¸ªé¡¹ç›®çš„ä¼šè¯çŠ¶æ€ç¼“å­˜: project -> { sessionId, outputHtml, status, costText }
    let projectStates = {};

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', async function() {
        await loadProjects();
        await loadRunningSessions();
    });

    // åŠ è½½å·²æœ‰è¿è¡Œä¸­çš„ä¼šè¯
    async function loadRunningSessions() {
        try {
            const resp = await fetch('/api/codegen/sessions');
            const data = await resp.json();
            if (!data.success) return;
            const sessions = data.data.sessions || [];
            for (const s of sessions) {
                if (!projectStates[s.project]) {
                    projectStates[s.project] = { sessionId: null, outputHtml: '', status: 'idle', costText: '' };
                }
                const state = projectStates[s.project];
                // ä¿ç•™æœ€æ–°çš„ session
                if (!state.sessionId || s.status === 'running') {
                    state.sessionId = s.id;
                    state.status = s.status === 'running' ? 'running' : 'done';
                }
            }
            renderProjects();
        } catch (e) { /* ignore */ }
    }

    function getProjectState(project) {
        if (!projectStates[project]) {
            projectStates[project] = { sessionId: null, outputHtml: '', status: 'idle', costText: '' };
        }
        return projectStates[project];
    }

    // åŠ è½½é¡¹ç›®åˆ—è¡¨
    async function loadProjects() {
        try {
            const resp = await fetch('/api/codegen/projects');
            const data = await resp.json();
            if (!data.success) throw new Error(data.error);

            document.getElementById('workspacePath').textContent = data.data.workspace;

            // æ›´æ–° agent çŠ¶æ€
            updateAgentStatus(data.data.agents || []);

            // ç¼“å­˜ä¸¤ç§æ¨¡å‹åˆ—è¡¨
            cachedClaudeCodeModels = data.data.claudecode_models || [];
            cachedOpenCodeModels = data.data.opencode_models || [];

            // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨ï¼ˆæ ¹æ®å½“å‰é€‰æ‹©çš„å·¥å…·ï¼‰
            const toolSelect = document.getElementById('toolSelect');
            const currentTool = toolSelect.value;
            const models = currentTool === 'opencode' ? cachedOpenCodeModels : cachedClaudeCodeModels;
            updateModelSelect(models);

            // æ›´æ–°å·¥å…·é€‰æ‹©å™¨
            updateToolSelect(data.data.tools || []);

            // åˆå¹¶æœ¬åœ°å’Œè¿œç¨‹é¡¹ç›®
            const localProjects = data.data.projects || [];
            const remoteProjects = data.data.remote_projects || [];
            remoteProjectMap = {};
            remoteProjects.forEach(rp => { remoteProjectMap[rp.name] = rp; });

            // å»é‡ + æŒ‰åç§°æ’åºï¼ˆç¨³å®šï¼‰
            const localNames = new Set(localProjects.map(p => p.name));
            cachedLocalProjects = localProjects.slice().sort((a, b) => a.name.localeCompare(b.name));
            cachedRemoteOnly = remoteProjects
                .filter(rp => !localNames.has(rp.name))
                .sort((a, b) => a.name.localeCompare(b.name));

            // æŒ‰ tools æ‹†åˆ†è¿œç¨‹é¡¹ç›®ä¸ºç¼–ç å’Œéƒ¨ç½²ä¸¤ç»„
            const codingTools = ['claudecode', 'opencode'];
            cachedCodingRemote = remoteProjects
                .filter(rp => !localNames.has(rp.name) && rp.tools && rp.tools.some(t => codingTools.includes(t)))
                .sort((a, b) => a.name.localeCompare(b.name));
            cachedDeployProjects = remoteProjects
                .filter(rp => rp.tools && rp.tools.includes('deploy'))
                .sort((a, b) => a.name.localeCompare(b.name));

            renderProjects();
        } catch (err) {
            console.error('Load projects failed:', err);
        }
    }

    function updateAgentStatus(agents) {
        const el = document.getElementById('agentStatus');
        const dot = document.getElementById('agentDot');
        const text = document.getElementById('agentText');

        if (!agents || agents.length === 0) {
            el.style.display = 'none';
            return;
        }

        el.style.display = 'flex';
        dot.className = 'dot online';
        text.textContent = `${agents.length} Agent åœ¨çº¿`;
    }

    function updateModelSelect(models) {
        const select = document.getElementById('modelSelect');
        const currentVal = select.value;
        // ä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹
        select.innerHTML = '<option value="">é»˜è®¤</option>';
        if (models && models.length > 0) {
            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });
            select.style.display = '';
        } else {
            select.style.display = 'none';
        }
        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
        if (currentVal) {
            select.value = currentVal;
        }
    }

    function updateToolSelect(tools) {
        const select = document.getElementById('toolSelect');
        const currentVal = select.value;
        const toolLabels = { 'claudecode': 'Claude Code', 'opencode': 'OpenCode' };
        select.innerHTML = '';
        // é»˜è®¤é€‰é¡¹
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Claude Code';
        select.appendChild(defaultOpt);
        if (tools && tools.length > 0) {
            tools.forEach(t => {
                if (t === 'claudecode') return; // å·²æ˜¯é»˜è®¤
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = toolLabels[t] || t;
                select.appendChild(opt);
            });
            // åªæœ‰ä¸€ä¸ªå·¥å…·æ—¶éšè—é€‰æ‹©å™¨
            select.style.display = tools.length > 1 ? '' : 'none';
        } else {
            select.style.display = 'none';
        }
        if (currentVal) {
            select.value = currentVal;
        }
        // æ·»åŠ å·¥å…·åˆ‡æ¢äº‹ä»¶
        select.onchange = function() {
            updateModelSelectByTool(this.value);
        };
    }

    // æ ¹æ®å·¥å…·ç±»å‹æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
    function updateModelSelectByTool(tool) {
        let models = tool === 'opencode' ? cachedOpenCodeModels : cachedClaudeCodeModels;
        updateModelSelect(models || []);
    }

    function filterProjects() {
        renderProjects();
    }

    function getProjectStatusIndicator(projectName) {
        const state = projectStates[projectName];
        if (!state) return '';
        if (state.status === 'running') {
            return '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-left:6px;animation:pulse 1.5s infinite;vertical-align:middle;" title="è¿è¡Œä¸­"></span>';
        }
        return '';
    }

    function renderProjects() {
        const list = document.getElementById('projectList');
        const query = (document.getElementById('projectSearch').value || '').toLowerCase().trim();

        const localFiltered = cachedLocalProjects.filter(p => !query || p.name.toLowerCase().includes(query));
        const codingRemoteFiltered = cachedCodingRemote.filter(rp => !query || rp.name.toLowerCase().includes(query));
        const deployFiltered = cachedDeployProjects.filter(rp => !query || rp.name.toLowerCase().includes(query));

        if (localFiltered.length === 0 && codingRemoteFiltered.length === 0 && deployFiltered.length === 0) {
            list.innerHTML = query
                ? '<div style="padding: 20px; color: var(--text-muted); text-align: center; font-size: 13px;">æœªæ‰¾åˆ°åŒ¹é…é¡¹ç›®</div>'
                : '<div style="padding: 20px; color: var(--text-muted); text-align: center; font-size: 13px;">æš‚æ— é¡¹ç›®<br>ç‚¹å‡» + æ–°å»º åˆ›å»º</div>';
            return;
        }

        let html = '';

        // ç¼–ç é¡¹ç›®åŒºåŸŸ
        const hasCodingProjects = localFiltered.length > 0 || codingRemoteFiltered.length > 0;
        if (hasCodingProjects) {
            html += '<div class="agent-section-header">ğŸ’» ç¼–ç é¡¹ç›®</div>';
            // æœ¬åœ°é¡¹ç›®
            html += localFiltered.map(p => {
                const agentBadge = remoteProjectMap[p.name]
                    ? `<span class="agent-badge">${remoteProjectMap[p.name].agent}</span>`
                    : '';
                const statusDot = getProjectStatusIndicator(p.name);
                const state = projectStates[p.name];
                const statusMeta = state && state.status === 'running' ? ' Â· <span style="color:var(--green)">è¿è¡Œä¸­</span>' : '';
                const isActive = currentProject === p.name && currentMode === 'code';
                return `
                <div class="project-item ${isActive ? 'active' : ''}" onclick="selectProject('${p.name}', 'code')">
                    <div class="name">ğŸ“ ${p.name}${agentBadge}${statusDot}</div>
                    <div class="meta">${p.file_count} æ–‡ä»¶ Â· ${p.mod_time || 'æœªçŸ¥'}${statusMeta}</div>
                </div>`;
            }).join('');

            // è¿œç¨‹ç¼–ç é¡¹ç›®
            html += codingRemoteFiltered.map(rp => {
                const statusDot = getProjectStatusIndicator(rp.name);
                const state = projectStates[rp.name];
                const statusMeta = state && state.status === 'running' ? ' Â· <span style="color:var(--green)">è¿è¡Œä¸­</span>' : '';
                const isActive = currentProject === rp.name && currentMode === 'code';
                return `
                <div class="project-item ${isActive ? 'active' : ''}" onclick="selectProject('${rp.name}', 'code')">
                    <div class="name">ğŸ“ ${rp.name}<span class="agent-badge">${rp.agent}</span>${statusDot}</div>
                    <div class="meta">è¿œç¨‹ Â· ${rp.agent}${statusMeta}</div>
                </div>`;
            }).join('');
        }

        // éƒ¨ç½²é¡¹ç›®åŒºåŸŸ
        if (deployFiltered.length > 0) {
            html += '<div class="agent-section-header">ğŸš€ éƒ¨ç½²é¡¹ç›®</div>';
            html += deployFiltered.map(rp => {
                const statusDot = getProjectStatusIndicator(rp.name);
                const state = projectStates[rp.name];
                const statusMeta = state && state.status === 'running' ? ' Â· <span style="color:var(--green)">è¿è¡Œä¸­</span>' : '';
                const isActive = currentProject === rp.name && currentMode === 'deploy';
                return `
                <div class="project-item ${isActive ? 'active' : ''}" onclick="selectProject('${rp.name}', 'deploy')">
                    <div class="name">ğŸ“¦ ${rp.name}<span class="agent-badge">${rp.agent}</span>${statusDot}</div>
                    <div class="meta">éƒ¨ç½² Â· ${rp.agent}${statusMeta}</div>
                </div>`;
            }).join('');
        }

        list.innerHTML = html;
    }

    function selectProject(name, mode) {
        // ä¿å­˜å½“å‰é¡¹ç›®çš„è¾“å‡º
        if (currentProject) {
            saveCurrentProjectState();
        }

        currentProject = name;
        currentMode = mode || 'code';
        const state = getProjectState(name);
        currentSessionId = state.sessionId;

        renderProjects();
        document.getElementById('welcomeView').style.display = 'none';
        const output = document.getElementById('outputArea');
        output.classList.add('active');

        // æ ¹æ® mode åˆ‡æ¢è¾“å…¥åŒºåŸŸ
        if (currentMode === 'deploy') {
            document.getElementById('codeInputArea').style.display = 'none';
            document.getElementById('deployInputArea').style.display = 'flex';
        } else {
            document.getElementById('codeInputArea').style.display = 'flex';
            document.getElementById('deployInputArea').style.display = 'none';
        }

        // æ¢å¤è¯¥é¡¹ç›®çš„è¾“å‡º
        if (state.outputHtml) {
            output.innerHTML = state.outputHtml;
            output.scrollTop = output.scrollHeight;
        } else {
            output.innerHTML = '';
            const modeLabel = currentMode === 'deploy' ? 'éƒ¨ç½²' : 'ç¼–ç ';
            addEvent('system', `ğŸ“‚ å·²é€‰æ‹©${modeLabel}é¡¹ç›®: ${name}`);
            if (currentMode !== 'deploy') {
                loadProjectReadme(name);
            }
        }

        // æ¢å¤çŠ¶æ€æ 
        if (state.status === 'running') {
            const runLabel = currentMode === 'deploy' ? 'éƒ¨ç½²ä¸­...' : 'ç¼–ç ä¸­...';
            setStatus('running', runLabel);
            document.getElementById('btnSend').disabled = true;
            document.getElementById('btnStop').classList.add('visible');
            document.getElementById('btnDeployRun').disabled = true;
            document.getElementById('btnDeployStop').classList.add('visible');
            // é‡è¿ WebSocket
            if (currentSessionId) {
                connectWebSocket(currentSessionId);
            }
        } else {
            setStatus('idle', 'å°±ç»ª');
            document.getElementById('costText').textContent = state.costText || '';
            resetUI();
        }

        if (currentMode === 'code') {
            document.getElementById('promptInput').focus();
        }
    }

    function saveCurrentProjectState() {
        if (!currentProject) return;
        const state = getProjectState(currentProject);
        state.outputHtml = document.getElementById('outputArea').innerHTML;
        state.costText = document.getElementById('costText').textContent;
    }

    async function loadProjectReadme(project) {
        // å°è¯•å¤šä¸ªå¸¸è§ README æ–‡ä»¶å
        const readmeNames = ['README.md', 'readme.md', 'README', 'readme.txt'];
        for (const name of readmeNames) {
            try {
                const resp = await fetch(`/api/codegen/file?project=${encodeURIComponent(project)}&path=${encodeURIComponent(name)}`);
                const data = await resp.json();
                if (data.success && data.data && data.data.content) {
                    let content = data.data.content;
                    if (content.length > 1000) content = content.substring(0, 1000) + '\n...';
                    addEvent('assistant', `ğŸ“„ ${name}\n${content}`);
                    return;
                }
            } catch (e) { /* ignore */ }
        }
        // æ²¡æœ‰ README
        const area = document.getElementById('outputArea');
        const div = document.createElement('div');
        div.className = 'event-item system';
        div.innerHTML = `ğŸ“ è¯¥é¡¹ç›®æš‚æ—  READMEã€‚<a href="#" style="color: var(--accent); text-decoration: underline;" onclick="suggestReadme(); return false;">ç‚¹å‡»è®© Claude Code ç”Ÿæˆä¸€ä¸ª</a>`;
        area.appendChild(div);
    }

    function suggestReadme() {
        const input = document.getElementById('promptInput');
        input.value = 'è¯·åˆ†æé¡¹ç›®ä»£ç ï¼Œç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„ README.mdï¼ŒåŒ…å«é¡¹ç›®ç®€ä»‹ã€ä½¿ç”¨æ–¹æ³•ã€æŠ€æœ¯æ ˆç­‰ä¿¡æ¯ã€‚';
        input.focus();
    }

    // æ–°å»ºé¡¹ç›®
    function showNewProjectModal() {
        document.getElementById('newProjectModal').classList.add('active');
        document.getElementById('newProjectName').value = '';
        document.getElementById('newProjectName').focus();
    }
    function hideNewProjectModal() {
        document.getElementById('newProjectModal').classList.remove('active');
    }
    async function createProject() {
        const name = document.getElementById('newProjectName').value.trim();
        if (!name) return;
        try {
            const resp = await fetch('/api/codegen/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            const data = await resp.json();
            if (!data.success) throw new Error(data.error);
            hideNewProjectModal();
            selectProject(name);
            loadProjects();
        } catch (err) {
            alert('åˆ›å»ºå¤±è´¥: ' + err.message);
        }
    }

    // å‘é€ç¼–ç è¯·æ±‚
    async function sendPrompt() {
        const input = document.getElementById('promptInput');
        const prompt = input.value.trim();
        if (!prompt || !currentProject) {
            if (!currentProject) alert('è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºé¡¹ç›®');
            return;
        }

        input.value = '';
        addEvent('user', prompt);
        setStatus('running', 'æ­£åœ¨å¯åŠ¨ Claude Code...');
        document.getElementById('btnSend').disabled = true;
        document.getElementById('btnStop').classList.add('visible');

        const state = getProjectState(currentProject);
        state.status = 'running';
        renderProjects(); // æ›´æ–°ä¾§è¾¹æ è¿è¡ŒæŒ‡ç¤º

        try {
            let endpoint = '/api/codegen/run';
            let selectedModel = document.getElementById('modelSelect').value;
            let selectedTool = document.getElementById('toolSelect').value;
            let body = { project: currentProject, prompt, model: selectedModel, tool: selectedTool };
            let isFollowUp = false;

            if (currentSessionId) {
                // æ£€æŸ¥æ¨¡å‹æˆ–å·¥å…·æ˜¯å¦å˜æ›´ï¼Œå˜æ›´åˆ™å¼€æ–°ä¼šè¯
                if ((state.model && state.model !== selectedModel) ||
                    (state.tool !== undefined && state.tool !== selectedTool)) {
                    // æ¨¡å‹/å·¥å…·åˆ‡æ¢ï¼Œå¼€å…¨æ–°ä¼šè¯
                    currentSessionId = null;
                    state.sessionId = null;
                } else {
                    endpoint = '/api/codegen/message';
                    body = { session_id: currentSessionId, prompt };
                    isFollowUp = true;
                }
            }

            const resp = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await resp.json();
            if (!data.success) throw new Error(data.error);

            if (data.data.session_id) {
                currentSessionId = data.data.session_id;
                state.sessionId = currentSessionId;
                state.model = selectedModel;
                state.tool = selectedTool;
            }

            // è¿æ¥ WebSocketï¼ˆè¿½åŠ æ¶ˆæ¯æ—¶è·³è¿‡å†å²ï¼Œé¿å…é‡å¤æ˜¾ç¤ºï¼‰
            connectWebSocket(currentSessionId, isFollowUp);
        } catch (err) {
            addEvent('error', 'å¯åŠ¨å¤±è´¥: ' + err.message);
            state.status = 'error';
            renderProjects();
            resetUI();
        }
    }

    // ç›´æ¥éƒ¨ç½²ï¼ˆè·³è¿‡ç¼–ç ï¼‰
    async function deployProject() {
        if (!currentProject) {
            alert('è¯·å…ˆé€‰æ‹©é¡¹ç›®');
            return;
        }

        addEvent('user', 'ğŸš€ ç›´æ¥éƒ¨ç½²é¡¹ç›®');
        setStatus('running', 'æ­£åœ¨éƒ¨ç½²...');
        document.getElementById('btnDeployRun').disabled = true;
        document.getElementById('btnDeployStop').classList.add('visible');

        const state = getProjectState(currentProject);
        state.status = 'running';
        renderProjects();

        try {
            const resp = await fetch('/api/codegen/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project: currentProject, deploy_only: true })
            });
            const data = await resp.json();
            if (!data.success) throw new Error(data.error);

            currentSessionId = data.data.session_id;
            state.sessionId = currentSessionId;
            connectWebSocket(currentSessionId, false);
        } catch (err) {
            addEvent('error', 'éƒ¨ç½²å¯åŠ¨å¤±è´¥: ' + err.message);
            state.status = 'error';
            renderProjects();
            resetUI();
        }
    }

    // WebSocket è¿æ¥
    function connectWebSocket(sessionId, skipHistory) {
        if (ws) ws.close();
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsProject = currentProject; // æ•è·å½“å‰é¡¹ç›®
        let wsUrl = `${protocol}//${location.host}/ws/codegen?session_id=${sessionId}`;
        if (skipHistory) {
            wsUrl += '&skip_history=1';
        }
        ws = new WebSocket(wsUrl);

        ws.onmessage = function(e) {
            const event = JSON.parse(e.data);
            const isActiveProject = (currentProject === wsProject);

            if (event.type === 'tool') {
                if (isActiveProject) addToolEvent(event);
            } else if (event.type === 'thinking') {
                if (isActiveProject) addThinkingEvent(event.text);
            } else if (event.type === 'assistant') {
                if (isActiveProject) addEvent('assistant', event.text);
            } else if (event.type === 'result') {
                // åªæœ‰ done=true æˆ–æœ‰ text æ—¶æ‰æ˜¾ç¤º
                if (event.done || (event.text && event.text.trim())) {
                    let summary = event.text || 'âœ… ç¼–ç å®Œæˆ';
                    if (isActiveProject) addEvent('result', summary);
                }
                let stats = [];
                if (event.cost_usd > 0) stats.push(`ğŸ’° $${event.cost_usd.toFixed(4)}`);
                if (event.tokens_in > 0 || event.tokens_out > 0) stats.push(`ğŸ“Š ${event.tokens_in || 0} â†’ ${event.tokens_out || 0} tokens`);
                if (event.duration_ms > 0) stats.push(`â± ${(event.duration_ms / 1000).toFixed(1)}s`);
                if (event.num_turns > 0) stats.push(`ğŸ”„ ${event.num_turns} turns`);
                if (stats.length > 0) {
                    const statsText = stats.join(' Â· ');
                    // åªæœ‰ done=true æ—¶æ‰åœ¨è¾“å‡ºåŒºæ˜¾ç¤ºç»Ÿè®¡
                    if (isActiveProject && event.done) {
                        document.getElementById('costText').textContent = statsText;
                        addEvent('system', statsText);
                    }
                    const state = getProjectState(wsProject);
                    if (event.done) {
                        state.costText = stats.join(' Â· ');
                    }
                }
            } else if (event.type === 'error') {
                if (isActiveProject) addEvent('error', event.text);
            } else if (event.type === 'summary') {
                if (isActiveProject) addEvent('result', event.text);
            } else if (event.type === 'system') {
                if (isActiveProject) addEvent('system', event.text);
            } else {
                if (isActiveProject) addEvent('system', event.text || JSON.stringify(event));
            }

            // ä¿å­˜éæ´»è·ƒé¡¹ç›®çš„è¾“å‡ºåˆ°ç¼“å­˜
            if (!isActiveProject) {
                // æ„å»ºäº‹ä»¶ HTML è¿½åŠ åˆ°ç¼“å­˜
                const state = getProjectState(wsProject);
                state.outputHtml += buildEventHtml(event);
            }

            if (event.done) {
                const state = getProjectState(wsProject);
                state.status = (event.type === 'error') ? 'error' : 'done';
                if (isActiveProject) {
                    if (event.type === 'error') {
                        setStatus('error', 'âŒ å¤±è´¥');
                    } else {
                        setStatus('done', 'âœ… å®Œæˆ');
                    }
                    resetUI();
                }
                // ä¿å­˜æœ€ç»ˆè¾“å‡º
                if (isActiveProject) {
                    saveCurrentProjectState();
                }
                renderProjects(); // æ›´æ–°ä¾§è¾¹æ çŠ¶æ€
            } else {
                if (isActiveProject) setStatus('running', 'ç¼–ç ä¸­...');
            }
        };

        ws.onerror = function() {
            if (currentProject === wsProject) {
                addEvent('error', 'WebSocket è¿æ¥å¤±è´¥');
                resetUI();
            }
        };

        ws.onclose = function() {
            // don't overwrite error/done status
        };
    }

    // æ„å»ºäº‹ä»¶ HTMLï¼ˆç”¨äºç¼“å­˜éæ´»è·ƒé¡¹ç›®çš„è¾“å‡ºï¼‰
    function buildEventHtml(event) {
        let cls = event.type || 'system';
        let content = '';
        if (event.type === 'user') {
            content = `<strong>ğŸ‘¤ ä½ :</strong> ${escapeHtml(event.text || '')}`;
        } else if (event.type === 'thinking') {
            const text = event.text || '';
            const preview = text.length > 80 ? text.substring(0, 80).replace(/\n/g, ' ') + '...' : text.replace(/\n/g, ' ');
            content = `<div class="thinking-header"><span class="toggle-icon">â–¶</span> ğŸ’­ æ€è€ƒ: ${escapeHtml(preview)}</div><div class="thinking-content">${escapeHtml(text)}</div>`;
            return `<div class="event-item thinking collapsed" onclick="this.classList.toggle('collapsed')">${content}</div>`;
        } else if (event.type === 'tool') {
            content = buildToolContent(event);
        } else if (event.type === 'result') {
            // åªæœ‰ done=true æˆ–æœ‰ text æ—¶æ‰è®°å½•
            if (!event.done && !(event.text && event.text.trim())) {
                return '';
            }
            content = escapeHtml(event.text || 'âœ… ç¼–ç å®Œæˆ');
        } else {
            content = escapeHtml(event.text || '');
        }
        return content ? `<div class="event-item ${cls}">${content}</div>` : '';
    }

    // åœæ­¢ä¼šè¯
    async function stopSession() {
        if (!currentSessionId) return;
        try {
            await fetch('/api/codegen/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: currentSessionId })
            });
        } catch (err) {
            console.error('Stop failed:', err);
        }
        if (currentProject) {
            const state = getProjectState(currentProject);
            state.status = 'stopped';
        }
        renderProjects();
        resetUI();
    }

    // æ·»åŠ å·¥å…·äº‹ä»¶ï¼ˆè¯¦ç»†æ˜¾ç¤ºï¼‰
    function addToolEvent(event) {
        const area = document.getElementById('outputArea');
        const div = document.createElement('div');
        div.className = 'event-item tool';
        div.innerHTML = buildToolContent(event);
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    // æ·»åŠ æ€è€ƒè¿‡ç¨‹äº‹ä»¶ï¼ˆå¯æŠ˜å ï¼‰
    function addThinkingEvent(text) {
        const area = document.getElementById('outputArea');
        const div = document.createElement('div');
        div.className = 'event-item thinking collapsed';
        const preview = text.length > 80 ? text.substring(0, 80).replace(/\n/g, ' ') + '...' : text.replace(/\n/g, ' ');
        div.innerHTML = `<div class="thinking-header"><span class="toggle-icon">â–¶</span> ğŸ’­ æ€è€ƒ: ${escapeHtml(preview)}</div><div class="thinking-content">${escapeHtml(text)}</div>`;
        div.addEventListener('click', function() {
            div.classList.toggle('collapsed');
        });
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    // æ„å»ºå·¥å…·è¯¦ç»†å†…å®¹
    function buildToolContent(event) {
        const name = event.tool_name || 'unknown';
        let input = event.tool_input || '';
        
        // ä¼˜å…ˆä½¿ç”¨åç«¯ç”Ÿæˆçš„ Textï¼ˆå·²æ ¼å¼åŒ–ï¼‰
        if (event.text && event.text.trim()) {
            return `<div class="tool-header">ğŸ”§ ${escapeHtml(name)}</div><div class="tool-detail">${escapeHtml(event.text)}</div>`;
        }

        // å¦åˆ™å°è¯•è§£æ tool_input
        let detail = '';
        try {
            const parsed = JSON.parse(input);
            detail = formatToolDetail(name, parsed);
        } catch (e) {
            detail = input;
        }

        return `<div class="tool-header">ğŸ”§ ${escapeHtml(name)}</div><div class="tool-detail">${escapeHtml(detail)}</div>`;
    }

    // æ ¹æ®å·¥å…·ç±»å‹æ ¼å¼åŒ–è¯¦ç»†å‚æ•°
    function formatToolDetail(toolName, params) {
        // å…¼å®¹ä¸åŒå­—æ®µå
        const filePath = params.filePath || params.file_path || params.path || '';
        const cmd = params.command || params.cmd || '';
        
        switch (toolName.toLowerCase()) {
            case 'write':
            case 'write_file':
                return `æ–‡ä»¶: ${filePath}${params.content ? '\nå†…å®¹:\n' + (params.content.length > 500 ? params.content.substring(0, 500) + '...' : params.content) : ''}`;
            case 'read':
            case 'read_file':
                return `æ–‡ä»¶: ${filePath}${params.offset ? '  offset=' + params.offset : ''}${params.limit ? '  limit=' + params.limit : ''}`;
            case 'edit':
            case 'edit_file':
                let s = `æ–‡ä»¶: ${filePath}`;
                if (params.old_string) s += `\næŸ¥æ‰¾:\n${params.old_string}`;
                if (params.new_string) s += `\næ›¿æ¢:\n${params.new_string}`;
                return s;
            case 'bash':
            case 'run_command':
                return `å‘½ä»¤: ${cmd}${params.description ? '\nè¯´æ˜: ' + params.description : ''}`;
            case 'glob':
                return `æ¨¡å¼: ${params.pattern || ''}${params.path ? '  è·¯å¾„: ' + params.path : ''}`;
            case 'grep':
            case 'search':
                return `æ¨¡å¼: ${params.pattern || ''}${params.path ? '  è·¯å¾„: ' + params.path : ''}${params.glob ? '  æ–‡ä»¶: ' + params.glob : ''}`;
            case 'listdir':
            case 'list_dir':
                return `è·¯å¾„: ${params.path || '.'}`;
            default:
                // é€šç”¨ï¼šæ˜¾ç¤ºæ‰€æœ‰å‚æ•°
                return Object.entries(params).map(([k, v]) => {
                    const val = typeof v === 'string' ? (v.length > 500 ? v.substring(0, 500) + '...' : v) : JSON.stringify(v);
                    return `${k}: ${val}`;
                }).join('\n');
        }
    }

    // UI å·¥å…·å‡½æ•°
    function addEvent(type, text) {
        const area = document.getElementById('outputArea');
        const div = document.createElement('div');
        div.className = `event-item ${type}`;
        
        if (type === 'user') {
            div.innerHTML = `<strong>ğŸ‘¤ ä½ :</strong> ${escapeHtml(text)}`;
        } else {
            div.textContent = text;
        }
        
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    function setStatus(state, text) {
        const dot = document.getElementById('statusDot');
        dot.className = `status-dot ${state === 'running' ? 'running' : ''}`;
        document.getElementById('statusText').textContent = text;
    }

    function resetUI() {
        document.getElementById('btnSend').disabled = false;
        document.getElementById('btnStop').classList.remove('visible');
        document.getElementById('btnDeployRun').disabled = false;
        document.getElementById('btnDeployStop').classList.remove('visible');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    </script>
</body>
</html>
