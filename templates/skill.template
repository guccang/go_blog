<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€èƒ½å­¦ä¹  - GUCCANG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/skill.css">
</head>
<body>
    <div class="top-sidebar-cotainer">
      <div class="top-sidebar">
        <div class="nav-container">
            <a href="/main">
                <div class="img-cycle">G</div>
            </a>
        </div>
        <div class="search-toggle-container">
            <h1 class="page-title" style="margin:0;color:var(--text-color);font-size:24px;">ğŸ¯ æŠ€èƒ½å­¦ä¹ </h1>
        </div>
      </div>
    </div>

    <div class="container">
        <!-- æ·»åŠ æ–°æŠ€èƒ½å¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æ·»åŠ æ–°æŠ€èƒ½</h2>
            </div>
            <div class="card-body">
                <form id="addSkillForm" class="skill-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="skillName">æŠ€èƒ½åç§°</label>
                            <input type="text" id="skillName" name="name" required placeholder="ä¾‹å¦‚ï¼šGoè¯­è¨€ç¼–ç¨‹">
                        </div>
                        <div class="form-group">
                            <label for="skillCategory">åˆ†ç±»</label>
                            <input type="text" id="skillCategory" name="category" placeholder="ä¾‹å¦‚ï¼šç¼–ç¨‹è¯­è¨€">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="skillDescription">æŠ€èƒ½æè¿°</label>
                        <textarea id="skillDescription" name="description" rows="3" placeholder="æè¿°è¿™ä¸ªæŠ€èƒ½çš„ç›®æ ‡å’Œå­¦ä¹ å†…å®¹..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="currentLevel">å½“å‰æ°´å¹³</label>
                            <select id="currentLevel" name="level">
                                <option value="beginner">åˆå­¦è€…</option>
                                <option value="intermediate">ä¸­çº§</option>
                                <option value="advanced">é«˜çº§</option>
                                <option value="expert">ä¸“å®¶</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="targetLevel">ç›®æ ‡æ°´å¹³</label>
                            <select id="targetLevel" name="target_level">
                                <option value="beginner">åˆå­¦è€…</option>
                                <option value="intermediate">ä¸­çº§</option>
                                <option value="advanced" selected>é«˜çº§</option>
                                <option value="expert">ä¸“å®¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="skillTags">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <input type="text" id="skillTags" name="tags" placeholder="ä¾‹å¦‚ï¼šç¼–ç¨‹,åç«¯,å¹¶å‘">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="skillActive" name="is_active" checked>
                            <span class="checkmark"></span>
                            ç«‹å³å¼€å§‹å­¦ä¹ 
                        </label>
                    </div>
                    <button type="submit" class="add-btn">åˆ›å»ºæŠ€èƒ½</button>
                </form>
            </div>
        </div>

        <!-- æŠ€èƒ½åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header">
            <div class="card-body">
                <div id="skillsList" class="skills-grid">
                    <!-- æŠ€èƒ½å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æŠ€èƒ½è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="skillDetailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalSkillTitle" class="modal-title">æŠ€èƒ½è¯¦æƒ…</h3>
                    <span class="close-modal" onclick="closeSkillModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="skill-info">
                        <div class="skill-meta">
                            <span class="skill-category" id="modalSkillCategory"></span>
                            <span class="skill-level" id="modalSkillLevel"></span>
                            <span class="skill-progress" id="modalSkillProgress"></span>
                        </div>
                        <p class="skill-description" id="modalSkillDescription"></p>
                    </div>

                    <!-- æ—¶é—´è½´éƒ¨åˆ† - å…¨é¡µé¢æ˜¾ç¤º -->
                    <div class="timeline-section full-page">
                        <div class="timeline-header">
                            <h4>å­¦ä¹ æ—¶é—´è½´</h4>
                            <button class="btn btn-primary" onclick="openAddContentModal()">
                                <i class="fas fa-plus"></i> æ·»åŠ å­¦ä¹ å†…å®¹
                            </button>
                        </div>
                        <div id="timelineContainer" class="timeline-container">
                            <!-- æ—¶é—´è½´å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeSkillModal()">å…³é—­</button>
                    <button class="btn btn-danger" onclick="deleteCurrentSkill()">åˆ é™¤æŠ€èƒ½</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ å­¦ä¹ å†…å®¹æ¨¡æ€æ¡† - å…¨å±æ¨¡å¼ -->
        <div id="addContentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">æ·»åŠ å­¦ä¹ å†…å®¹</h3>
                    <span class="close-modal" onclick="closeAddContentModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="fullscreen-form-container">
                        <form id="addContentForm" class="content-form fullscreen-form">
                            <div class="form-section">
                                <h4 class="form-section-title">åŸºæœ¬ä¿¡æ¯</h4>
                                <div class="form-row">
                                    <div class="form-group fullscreen-form-group">
                                        <label for="contentTitle">å†…å®¹æ ‡é¢˜</label>
                                        <input type="text" id="contentTitle" name="title" required placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ Goåç¨‹">
                                    </div>
                                    <div class="form-group fullscreen-form-group">
                                        <label for="contentStatus">çŠ¶æ€</label>
                                        <select id="contentStatus" name="status">
                                            <option value="planned">è®¡åˆ’ä¸­</option>
                                            <option value="in_progress">è¿›è¡Œä¸­</option>
                                            <option value="completed">å·²å®Œæˆ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group fullscreen-form-group">
                                    <label for="contentDescription">è¯¦ç»†æè¿°</label>
                                    <textarea id="contentDescription" name="description" rows="3" placeholder="æè¿°å…·ä½“çš„å­¦ä¹ å†…å®¹..."></textarea>
                                </div>
                            </div>

                            <div class="form-section">
                                <h4 class="form-section-title">å­¦ä¹ è¯¦æƒ…</h4>
                                <div class="form-row">
                                    <div class="form-group fullscreen-form-group">
                                        <label for="contentPriority">ä¼˜å…ˆçº§ (1-10)</label>
                                        <input type="number" id="contentPriority" name="priority" min="1" max="10" value="5">
                                    </div>
                                    <div class="form-group fullscreen-form-group">
                                        <label for="contentTimeSpent">å·²èŠ±è´¹æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                                        <input type="number" id="contentTimeSpent" name="time_spent" min="0" value="0">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h4 class="form-section-title">å­¦ä¹ èµ„æº</h4>
                                <div class="form-group fullscreen-form-group">
                                    <label for="contentResources">èµ„æºé“¾æ¥ï¼ˆæ¯è¡Œä¸€ä¸ªURLï¼‰</label>
                                    <textarea id="contentResources" name="resources" rows="4" placeholder="https://example.com/tutorial
https://docs.example.com/guide"></textarea>
                                </div>
                            </div>

                            <div class="form-section">
                                <h4 class="form-section-title">å­¦ä¹ ç¬”è®°</h4>
                                <div class="form-group fullscreen-form-group">
                                    <label for="contentNotes">è¯¦ç»†ç¬”è®°å’Œå¿ƒå¾—</label>
                                    <textarea id="contentNotes" name="notes" rows="6" placeholder="è®°å½•å­¦ä¹ è¿‡ç¨‹ä¸­çš„è¦ç‚¹ã€å¿ƒå¾—ã€é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAddContentModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="handleAddContent()">æ·»åŠ å†…å®¹</button>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ•°æ®å¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">å­¦ä¹ ç»Ÿè®¡</h2>
            </div>
            <div class="card-body">
                <div id="skillStats" class="stats-grid">
                    <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toastå®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- åˆ›å»ºæŒ‰é’® -->
    <a href="#" class="create-btn" title="æ·»åŠ æ–°æŠ€èƒ½" onclick="document.getElementById('skillName').focus(); return false;">+</a>

    <!-- æ™ºèƒ½åŠ©æ‰‹æ‚¬æµ®å›¾æ ‡ -->
    <a href="/assistant" class="assistant-floating-btn" title="æ™ºèƒ½åŠ©æ‰‹">
        <i class="fas fa-robot"></i>
    </a>

    <script>
        // å…¨å±€å˜é‡
        let currentSkillId = null;
        let skillsData = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSkills();
            loadSkillStats();
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ·»åŠ æŠ€èƒ½è¡¨å•
            document.getElementById('addSkillForm').addEventListener('submit', handleAddSkill);
            
            // æ¨¡æ€æ¡†å…³é—­
            document.querySelectorAll('.close-modal').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    if (this.onclick) {
                        this.onclick();
                    }
                });
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('skillDetailModal')) {
                    closeSkillModal();
                }
                if (event.target === document.getElementById('addContentModal')) {
                    closeAddContentModal();
                }
            });
        }

        // åŠ è½½æ‰€æœ‰æŠ€èƒ½
        function loadSkills() {
            fetch('/api/skills')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        skillsData = data.skills;
                        renderSkills(skillsData);
                    }
                })
                .catch(error => {
                    showToast('åŠ è½½æŠ€èƒ½å¤±è´¥: ' + error.message, 'error');
                });
        }

        // åŠ è½½æŠ€èƒ½ç»Ÿè®¡
        function loadSkillStats() {
            fetch('/api/skills/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderSkillStats(data.stats);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
                });
        }

       // æ¸²æŸ“æŠ€èƒ½å¡ç‰‡
        function renderSkills(skills) {
            const container = document.getElementById('skillsList');
            container.innerHTML = '';

            if (skills.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-graduation-cap"></i>
                        <p>è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•æŠ€èƒ½</p>
                        <p>ç‚¹å‡»ä¸Šæ–¹"åˆ›å»ºæŠ€èƒ½"å¼€å§‹ä½ çš„å­¦ä¹ ä¹‹æ—…</p>
                    </div>
                `;
                return;
            }

            skills.forEach(skill => {
                const skillCard = createSkillCard(skill);
                container.appendChild(skillCard);
            });
        }

        // åˆ›å»ºå•ä¸ªæŠ€èƒ½å¡ç‰‡
        function createSkillCard(skill) {
            const card = document.createElement('div');
            card.className = 'skill-card';
            card.innerHTML = `
                <div class="skill-card-header">
                    <h3 class="skill-name">${escapeHtml(skill.name)}</h3>
                    <span class="skill-category">${escapeHtml(skill.category || 'æœªåˆ†ç±»')}</span>
                </div>
                <div class="skill-card-body">
                    <p class="skill-description">${truncateText(escapeHtml(skill.description || 'æš‚æ— æè¿°'), 100)}</p>
                    <div class="skill-progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${skill.progress || 0}%"></div>
                        </div>
                        <span class="progress-text">${Math.round(skill.progress || 0)}%</span>
                    </div>
                    <div class="skill-meta">
                        <span class="skill-level">${getLevelText(skill.level)}</span>
                        <span class="skill-items">${skill.contents ? skill.contents.length : 0} ä¸ªå­¦ä¹ é¡¹</span>
                    </div>
                </div>
                <div class="skill-card-footer">
                    <button class="btn btn-primary" onclick="viewSkill('${skill.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                    ${skill.is_active ? '<span class="status-badge active">æ´»è·ƒ</span>' : '<span class="status-badge inactive">æš‚åœ</span>'}
                </div>
            `;
            return card;
        }

        // æŸ¥çœ‹æŠ€èƒ½è¯¦æƒ…
        function viewSkill(skillId) {
            fetch(`/api/skill/${skillId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentSkillId = skillId;
                        // æ›´æ–°skillsDataä¸­çš„æŠ€èƒ½æ•°æ®ï¼Œä»¥ä¾¿ç¼–è¾‘æ—¶ä½¿ç”¨
                        const index = skillsData.findIndex(skill => skill.id === skillId);
                        if (index !== -1) {
                            skillsData[index] = data.skill;
                        } else {
                            skillsData.push(data.skill);
                        }
                        showSkillModal(data.skill);
                    }
                })
                .catch(error => {
                    showToast('åŠ è½½æŠ€èƒ½è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
                });
        }

        // æ˜¾ç¤ºæŠ€èƒ½æ¨¡æ€æ¡†
        function showSkillModal(skill) {
            document.getElementById('modalSkillTitle').textContent = skill.name;
            document.getElementById('modalSkillCategory').textContent = skill.category || 'æœªåˆ†ç±»';
            document.getElementById('modalSkillLevel').textContent = getLevelText(skill.level);
            document.getElementById('modalSkillProgress').textContent = `è¿›åº¦: ${Math.round(skill.progress || 0)}%`;
            document.getElementById('modalSkillDescription').textContent = skill.description || 'æš‚æ— æè¿°';

            renderTimeline(skill.contents || []);
            document.getElementById('skillDetailModal').style.display = 'block';
        }

        // æ‰“å¼€æ·»åŠ å†…å®¹æ¨¡æ€æ¡†
        function openAddContentModal() {
            if (!currentSkillId) {
                showToast('è¯·å…ˆé€‰æ‹©æŠ€èƒ½', 'error');
                return;
            }
            document.getElementById('addContentModal').style.display = 'block';
        }

        // å…³é—­æ·»åŠ å†…å®¹æ¨¡æ€æ¡†
        function closeAddContentModal() {
            document.getElementById('addContentModal').style.display = 'none';
            document.getElementById('addContentForm').reset();
            
            // é‡ç½®ç¼–è¾‘çŠ¶æ€
            if (window.editingContentId) {
                window.editingContentId = null;
                // æ¢å¤æ·»åŠ æ¨¡å¼
                document.querySelector('#addContentModal .modal-title').textContent = 'æ·»åŠ å­¦ä¹ å†…å®¹';
                const submitBtn = document.querySelector('#addContentModal .btn-primary');
                submitBtn.textContent = 'æ·»åŠ å†…å®¹';
                submitBtn.onclick = handleAddContent;
            }
        }

        // å…³é—­æŠ€èƒ½æ¨¡æ€æ¡†
        function closeSkillModal() {
            document.getElementById('skillDetailModal').style.display = 'none';
            currentSkillId = null;
        }

        // æ¸²æŸ“æ—¶é—´è½´
        function renderTimeline(contents) {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';

            if (contents.length === 0) {
                container.innerHTML = `
                    <div class="empty-timeline">
                        <i class="fas fa-history"></i>
                        <p>è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</p>
                        <p>æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªå­¦ä¹ å†…å®¹å¼€å§‹è®°å½•</p>
                    </div>
                `;
                return;
            }

            contents.forEach((content, index) => {
                const timelineItem = createTimelineItem(content, index, contents.length);
                container.appendChild(timelineItem);
            });
        }

        // åˆ›å»ºæ—¶é—´è½´é¡¹
        function createTimelineItem(content, index, totalItems) {
            const item = document.createElement('div');
            item.className = 'timeline-item';
            
            const date = new Date(content.created_at);
            const formattedDate = date.toLocaleDateString('zh-CN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            const formattedTime = date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const timeAgo = getTimeAgo(content.created_at);
            
            item.innerHTML = `
                <div class="timeline-marker">
                    <div class="timeline-time-badge">
                        <div class="time-hour">${formattedTime}</div>
                        <div class="time-ago">${timeAgo}</div>
                    </div>
                    <div class="timeline-dot ${content.status}"></div>
                    ${index < totalItems - 1 ? '<div class="timeline-line"></div>' : ''}
                </div>
                <div class="timeline-content">
                    <div class="timeline-header">
                        <div class="timeline-date-info">
                            <div class="timeline-full-date">${formattedDate}</div>
                            <div class="timeline-time-details">
                                <span class="time-icon">ğŸ•’</span>
                                <span class="time-display">${formattedTime}</span>
                                <span class="time-ago-badge">${timeAgo}</span>
                            </div>
                        </div>
                        <h4 class="content-title">${escapeHtml(content.title)}</h4>
                    </div>
                    <div class="content-status ${content.status}">
                        ${getStatusText(content.status)}
                    </div>
                    ${content.description ? `<p class="content-description">${escapeHtml(content.description)}</p>` : ''}
                    ${content.time_spent > 0 ? `<div class="content-time">â±ï¸ èŠ±è´¹æ—¶é—´: ${content.time_spent} åˆ†é’Ÿ</div>` : ''}
                    ${content.notes ? `<div class="content-notes">ğŸ“ ${escapeHtml(content.notes)}</div>` : ''}
                    ${content.resources && content.resources.length > 0 ? `
                        <div class="content-resources">
                            <strong>ğŸ“š å­¦ä¹ èµ„æº:</strong>
                            <ul>
                                ${content.resources.map(resource => `<li><a href="${escapeHtml(resource)}" target="_blank">${escapeHtml(resource)}</a></li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    <div class="timeline-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editContent('${content.id}')">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteContent('${content.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `;
            return item;
        }

        // å¤„ç†æ·»åŠ æŠ€èƒ½
        function handleAddSkill(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const skillData = {
                name: formData.get('name'),
                description: formData.get('description'),
                category: formData.get('category'),
                level: formData.get('level'),
                target_level: formData.get('target_level'),
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                is_active: formData.get('is_active') === 'on',
                contents: []
            };

            fetch('/api/skill', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(skillData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('æŠ€èƒ½åˆ›å»ºæˆåŠŸ', 'success');
                    event.target.reset();
                    loadSkills();
                    loadSkillStats();
                } else {
                    showToast('åˆ›å»ºæŠ€èƒ½å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                showToast('åˆ›å»ºæŠ€èƒ½å¤±è´¥: ' + error.message, 'error');
            });
        }

        // å¤„ç†æ·»åŠ å†…å®¹
        function handleAddContent() {
            if (!currentSkillId) {
                showToast('è¯·å…ˆé€‰æ‹©æŠ€èƒ½', 'error');
                return;
            }

            const form = document.getElementById('addContentForm');
            const formData = new FormData(form);
            const contentData = {
                title: formData.get('title'),
                description: formData.get('description'),
                status: formData.get('status'),
                priority: parseInt(formData.get('priority')),
                time_spent: parseInt(formData.get('time_spent')),
                resources: formData.get('resources') ? formData.get('resources').split('\n').map(url => url.trim()).filter(url => url) : [],
                notes: formData.get('notes')
            };

            fetch(`/api/skill/${currentSkillId}/content`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(contentData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('å­¦ä¹ å†…å®¹æ·»åŠ æˆåŠŸ', 'success');
                    form.reset();
                    closeAddContentModal();
                    viewSkill(currentSkillId); // é‡æ–°åŠ è½½è¯¦æƒ…
                    loadSkills(); // åˆ·æ–°åˆ—è¡¨
                    loadSkillStats(); // åˆ·æ–°ç»Ÿè®¡
                } else {
                    showToast('æ·»åŠ å†…å®¹å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                showToast('æ·»åŠ å†…å®¹å¤±è´¥: ' + error.message, 'error');
            });
        }

        // ç¼–è¾‘å†…å®¹
        function editContent(contentId) {
            if (!currentSkillId) {
                showToast('è¯·å…ˆé€‰æ‹©æŠ€èƒ½', 'error');
                return;
            }

            // ä»å½“å‰æŠ€èƒ½æ•°æ®ä¸­æŸ¥æ‰¾å†…å®¹ï¼ˆå› ä¸ºAPIæ²¡æœ‰å•ç‹¬è·å–å†…å®¹çš„æ¥å£ï¼‰
            const currentSkill = skillsData.find(skill => skill.id === currentSkillId);
            if (!currentSkill || !currentSkill.contents) {
                showToast('æ‰¾ä¸åˆ°å†…å®¹æ•°æ®', 'error');
                return;
            }

            const content = currentSkill.contents.find(c => c.id === contentId);
            if (!content) {
                showToast('æ‰¾ä¸åˆ°æŒ‡å®šçš„å­¦ä¹ å†…å®¹', 'error');
                return;
            }

            // å¡«å……è¡¨å•
            document.getElementById('contentTitle').value = content.title || '';
            document.getElementById('contentDescription').value = content.description || '';
            document.getElementById('contentStatus').value = content.status || 'planned';
            document.getElementById('contentPriority').value = content.priority || 5;
            document.getElementById('contentTimeSpent').value = content.time_spent || 0;
            document.getElementById('contentResources').value = content.resources ? content.resources.join('\n') : '';
            document.getElementById('contentNotes').value = content.notes || '';
            
            // è®¾ç½®ç¼–è¾‘æ¨¡å¼
            window.editingContentId = contentId;
            
            // æ‰“å¼€æ¨¡æ€æ¡†å¹¶ä¿®æ”¹æ ‡é¢˜
            document.getElementById('addContentModal').style.display = 'block';
            document.querySelector('#addContentModal .modal-title').textContent = 'ç¼–è¾‘å­¦ä¹ å†…å®¹';
            
            // ä¿®æ”¹æäº¤æŒ‰é’®æ–‡æœ¬
            const submitBtn = document.querySelector('#addContentModal .btn-primary');
            submitBtn.textContent = 'æ›´æ–°å†…å®¹';
            submitBtn.onclick = handleUpdateContent;
            
            showToast('å†…å®¹å·²åŠ è½½åˆ°ç¼–è¾‘è¡¨å•', 'success');
        }

        // å¤„ç†æ›´æ–°å†…å®¹
        function handleUpdateContent() {
            if (!currentSkillId || !window.editingContentId) {
                showToast('ç¼–è¾‘ä¿¡æ¯ä¸å®Œæ•´', 'error');
                return;
            }

            const form = document.getElementById('addContentForm');
            const formData = new FormData(form);
            const contentData = {
                title: formData.get('title'),
                description: formData.get('description'),
                status: formData.get('status'),
                priority: parseInt(formData.get('priority')),
                time_spent: parseInt(formData.get('time_spent')),
                resources: formData.get('resources') ? formData.get('resources').split('\n').map(url => url.trim()).filter(url => url) : [],
                notes: formData.get('notes')
            };

            fetch(`/api/skill/${currentSkillId}/content/${window.editingContentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(contentData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('å†…å®¹æ›´æ–°æˆåŠŸ', 'success');
                    closeAddContentModal();
                    viewSkill(currentSkillId); // é‡æ–°åŠ è½½è¯¦æƒ…
                    loadSkills(); // åˆ·æ–°åˆ—è¡¨
                    loadSkillStats(); // åˆ·æ–°ç»Ÿè®¡
                    
                    // é‡ç½®ç¼–è¾‘çŠ¶æ€
                    window.editingContentId = null;
                } else {
                    showToast('æ›´æ–°å†…å®¹å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                showToast('æ›´æ–°å†…å®¹å¤±è´¥: ' + error.message, 'error');
            });
        }

        // åˆ é™¤å†…å®¹
        function deleteContent(contentId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­¦ä¹ å†…å®¹å—ï¼Ÿ')) {
                return;
            }

            fetch(`/api/skill/${currentSkillId}/content/${contentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('å†…å®¹åˆ é™¤æˆåŠŸ', 'success');
                    viewSkill(currentSkillId); // é‡æ–°åŠ è½½è¯¦æƒ…
                    loadSkills(); // åˆ·æ–°åˆ—è¡¨
                    loadSkillStats(); // åˆ·æ–°ç»Ÿè®¡
                } else {
                    showToast('åˆ é™¤å†…å®¹å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                showToast('åˆ é™¤å†…å®¹å¤±è´¥: ' + error.message, 'error');
            });
        }

        // åˆ é™¤å½“å‰æŠ€èƒ½
        function deleteCurrentSkill() {
            if (!currentSkillId || !confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ€èƒ½å—ï¼Ÿæ‰€æœ‰å­¦ä¹ å†…å®¹ä¹Ÿå°†è¢«åˆ é™¤ã€‚')) {
                return;
            }

            fetch(`/api/skill/${currentSkillId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('æŠ€èƒ½åˆ é™¤æˆåŠŸ', 'success');
                    closeSkillModal();
                    loadSkills();
                    loadSkillStats();
                } else {
                    showToast('åˆ é™¤æŠ€èƒ½å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                showToast('åˆ é™¤æŠ€èƒ½å¤±è´¥: ' + error.message, 'error');
            });
        }

        // æ¸²æŸ“æŠ€èƒ½ç»Ÿè®¡
        function renderSkillStats(stats) {
            const container = document.getElementById('skillStats');
            container.innerHTML = `
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">${stats.total_skills}</div>
                        <div class="stat-label">æ€»æŠ€èƒ½æ•°</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">${stats.active_skills}</div>
                        <div class="stat-label">æ´»è·ƒæŠ€èƒ½</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">${stats.completed_skills}</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">${stats.total_contents}</div>
                        <div class="stat-label">å­¦ä¹ å†…å®¹</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">${Math.round(stats.avg_progress)}%</div>
                        <div class="stat-label">å¹³å‡è¿›åº¦</div>
                    </div>
                </div>
            `;
        }


        // æ›´æ–°æ—¶é—´çº¿æŠ€èƒ½è¿‡æ»¤å™¨é€‰é¡¹
        function updateTimelineSkillFilter(timeline) {
            const skills = new Set();
            timeline.forEach(item => {
                if (item.skill_name) {
                    skills.add(item.skill_name);
                }
            });

            const filter = document.getElementById('timelineSkillFilter');
            const currentValue = filter.value;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"æ‰€æœ‰æŠ€èƒ½"ï¼‰
            while (filter.options.length > 1) {
                filter.remove(1);
            }

            // æ·»åŠ æŠ€èƒ½é€‰é¡¹
            skills.forEach(skill => {
                const option = document.createElement('option');
                option.value = skill;
                option.textContent = skill;
                filter.appendChild(option);
            });

            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
            filter.value = currentValue;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–æ°´å¹³æ–‡æœ¬
        function getLevelText(level) {
            const levels = {
                'beginner': 'åˆå­¦è€…',
                'intermediate': 'ä¸­çº§',
                'advanced': 'é«˜çº§',
                'expert': 'ä¸“å®¶'
            };
            return levels[level] || level;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statuses = {
                'planned': 'è®¡åˆ’ä¸­',
                'in_progress': 'è¿›è¡Œä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            return statuses[status] || status;
        }

        // è¿‡æ»¤æ—¶é—´çº¿
        function filterTimeline() {
            const skillFilter = document.getElementById('timelineSkillFilter').value;
            const statusFilter = document.getElementById('timelineStatusFilter').value;
            const timeFilter = document.getElementById('timelineTimeFilter').value;

            fetch('/api/skills/timeline')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let filteredTimeline = data.timeline;

                        // åº”ç”¨æŠ€èƒ½è¿‡æ»¤
                        if (skillFilter) {
                            filteredTimeline = filteredTimeline.filter(item => item.skill_name === skillFilter);
                        }

                        // åº”ç”¨çŠ¶æ€è¿‡æ»¤
                        if (statusFilter) {
                            filteredTimeline = filteredTimeline.filter(item => item.status === statusFilter);
                        }

                        // åº”ç”¨æ—¶é—´è¿‡æ»¤
                        if (timeFilter !== 'all') {
                            const now = new Date();
                            let startDate;

                            switch (timeFilter) {
                                case 'week':
                                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                                    break;
                                case 'month':
                                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                                    break;
                                case 'year':
                                    startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                                    break;
                            }

                            filteredTimeline = filteredTimeline.filter(item => {
                                const itemDate = new Date(item.created_at);
                                return itemDate >= startDate;
                            });
                        }

                        renderGlobalTimeline(filteredTimeline);
                    }
                })
                .catch(error => {
                    console.error('è¿‡æ»¤æ—¶é—´çº¿å¤±è´¥:', error);
                });
        }

        // å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å·¥å…·å‡½æ•°ï¼šæˆªæ–­æ–‡æœ¬
        function truncateText(text, length) {
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–ç›¸å¯¹æ—¶é—´
        function getTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'åˆšåˆš';
            
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) return `${diffInMinutes}åˆ†é’Ÿå‰`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours}å°æ—¶å‰`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `${diffInDays}å¤©å‰`;
            
            const diffInWeeks = Math.floor(diffInDays / 7);
            if (diffInWeeks < 4) return `${diffInWeeks}å‘¨å‰`;
            
            const diffInMonths = Math.floor(diffInDays / 30);
            if (diffInMonths < 12) return `${diffInMonths}ä¸ªæœˆå‰`;
            
            return Math.floor(diffInDays / 365) + 'å¹´å‰';
        }

        // æ¸²æŸ“å…¨å±€æ—¶é—´çº¿
        function renderGlobalTimeline(timeline) {
            const container = document.getElementById('globalTimeline');
            container.innerHTML = '';

            if (timeline.length === 0) {
                container.innerHTML = `
                    <div class="empty-timeline">
                        <i class="fas fa-history"></i>
                        <p>æš‚æ— å­¦ä¹ è®°å½•</p>
                        <p>å¼€å§‹æ·»åŠ å­¦ä¹ å†…å®¹æ¥åˆ›å»ºæ—¶é—´çº¿</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groupedByDate = timeline.reduce((acc, item) => {
                const date = new Date(item.created_at).toLocaleDateString('zh-CN');
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(item);
                return acc;
            }, {});

            // æŒ‰æ—¥æœŸæ’åº
            const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                return new Date(b) - new Date(a);
            });

            sortedDates.forEach((date, dateIndex) => {
                const dateItems = groupedByDate[date];
                
                // åˆ›å»ºæ—¥æœŸæ ‡é¢˜
                const dateHeader = document.createElement('div');
                dateHeader.className = 'timeline-date-header';
                dateHeader.innerHTML = `
                    <div class="timeline-date-line"></div>
                    <div class="timeline-date-title">${date}</div>
                    <div class="timeline-date-line"></div>
                `;
                container.appendChild(dateHeader);

                // åˆ›å»ºè¯¥æ—¥æœŸçš„æ‰€æœ‰é¡¹ç›®
                dateItems.forEach((item, itemIndex) => {
                    const timelineItem = createGlobalTimelineItem(item, itemIndex, dateItems.length);
                    container.appendChild(timelineItem);
                });
            });
        }

        // åˆ›å»ºå…¨å±€æ—¶é—´çº¿é¡¹
        function createGlobalTimelineItem(item, index, totalItems) {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'global-timeline-item';
            
            const date = new Date(item.created_at);
            const formattedDate = date.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            timelineItem.innerHTML = `
                <div class="global-timeline-marker">
                    <div class="global-timeline-dot ${item.status}"></div>
                    ${index < totalItems - 1 ? '<div class="global-timeline-line"></div>' : ''}
                </div>
                <div class="global-timeline-content">
                    <div class="global-timeline-header">
                        <div class="global-timeline-skill">${escapeHtml(item.skill_name)}</div>
                        <span class="global-timeline-time">${formattedDate}</span>
                    </div>
                    <h4 class="global-timeline-title">${escapeHtml(item.title)}</h4>
                    <div class="global-timeline-status ${item.status}">
                        ${getStatusText(item.status)}
                    </div>
                    ${item.description ? `<p class="global-timeline-description">${escapeHtml(item.description)}</p>` : ''}
                    ${item.time_spent > 0 ? `<div class="global-timeline-time-spent">â±ï¸ èŠ±è´¹æ—¶é—´: ${item.time_spent} åˆ†é’Ÿ</div>` : ''}
                    <div class="global-timeline-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewSkill('${item.skill_id}')">æŸ¥çœ‹æŠ€èƒ½</button>
                    </div>
                </div>
            `;
            return timelineItem;
        }

        // æ˜¾ç¤ºToastæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>